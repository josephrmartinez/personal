<!DOCTYPE html>
<html lang="en" data-theme="lofi">
  <head>
    <!-- Global Metadata --><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<meta name="generator" content="Astro v2.0.5">

<!-- Primary Meta Tags -->
<title>Using a Jupyter Notebook for AI Model and Prompt Evals</title>
<meta name="title" content="Using a Jupyter Notebook for AI Model and Prompt Evals">
<meta name="description" content="A Better Way to Do Evals and Find the Best AI Model">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://josephm.dev/blog/20240801/">
<meta property="og:title" content="Using a Jupyter Notebook for AI Model and Prompt Evals">
<meta property="og:description" content="A Better Way to Do Evals and Find the Best AI Model">
<meta property="og:image" content="https://josephm.dev/social_img.webp">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://josephm.dev/blog/20240801/">
<meta property="twitter:title" content="Using a Jupyter Notebook for AI Model and Prompt Evals">
<meta property="twitter:description" content="A Better Way to Do Evals and Find the Best AI Model">
<meta property="twitter:image" content="https://josephm.dev/social_img.webp">
  <link rel="stylesheet" href="/_astro/_...page_.63dc1c2b.css" />
<link rel="stylesheet" href="/_astro/_slug_.a53bdabe.css" /></head>
  <body>
    <div class="bg-base-100 drawer drawer-mobile">
      <input id="my-drawer" type="checkbox" class="drawer-toggle">
      <div class="drawer-content flex flex-col bg-base-100">
        <div class="sticky lg:hidden top-0 z-30 flex h-16 w-full justify-center bg-opacity-90 backdrop-blur transition-all duration-100 bg-base-100 text-base-content shadow-sm">
  <div class="navbar">
    <div class="navbar-start">
      <label for="my-drawer" class="btn btn-square btn-ghost">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-5 h-5 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </label>
    </div>
    <div class="navbar-center">
      <a class="btn btn-ghost normal-case text-xl" href="/">üôã‚Äç‚ôÇÔ∏è</a>
    </div>
    <div class="navbar-end"></div>
  </div>
</div>
        <div class="md:flex md:justify-left">
          <main class="p-6 pt-10 w-full max-w-[900px]">
            <main class="md:flex md:justify-center">
    <article class="prose prose-lg max-w-[750px] prose-img:mx-auto">
      
      <h1 class="my-2 text-3xl font-semibold">Using a Jupyter Notebook for AI Model and Prompt Evals</h1>
      <time>Aug 1, 2024</time>
      
      <div class="divider my-2"></div>
      <h3 id="model-and-prompt-evals-for-a-clinical-charting-app-using-llms-in-production">Model and Prompt Evals for a Clinical Charting App Using LLMs in Production</h3>
<p><a href="https://github.com/josephrmartinez/soapnotescribe"><strong>soapnotescribe</strong></a> is a web application that utilizes AI to automatically generate structured SOAP notes from telehealth appointment recordings or clinical audio memos.</p>
<p>The application workflow involves first sending the audio of the medical appointment to a speech-to-text model hosted by Replicate. The transcribed text is then processed by a large language model (served by OpenAI or Anthropic) to organize the content into a structured data object, which is subsequently presented to the physician as a SOAP note.</p>
<p><img src="/blogimages/model_and_prompt_evals_files/diagram.png" alt="png"></p>
<p>‚ÄúSOAP‚Äù is an acronym for a standard template structure used by healthcare professionals to document patient encounters:</p>
<ul>
<li><strong>Subjective</strong>: Patient‚Äôs own words about symptoms and concerns.</li>
<li><strong>Objective</strong>: Measurable data from exams and tests.</li>
<li><strong>Assessment</strong>: Healthcare provider‚Äôs diagnosis or analysis.</li>
<li><strong>Plan</strong>: Treatment and follow-up recommendations.</li>
</ul>
<p>The transcription is performed using an optimized Whisper model, which takes approximately 6 seconds and costs around $0.005 for 5 minutes of audio.</p>
<p>A variety of LLM models can transform the transcription into a structured SOAP note. While all major foundational models can generate acceptable SOAP notes, they differ significantly in completion times, costs, and quality.</p>
<p>Previously, model selection was based mainly on minimizing costs and a general assessment of the outputs‚Äô acceptability. However, there was no systematic approach to understanding the performance and output differences between models.</p>
<p>The objective of this notebook is to establish a systematic evaluation process for selecting the LLM model and prompt used to convert audio transcriptions into structured SOAP notes.</p>
<p>Goals:</p>
<ul>
<li><strong>Identify Key Metrics</strong>: Determine the most critical outcomes for this use case, such as cost, speed, and accuracy in specific fields of the returned JSON object.</li>
<li><strong>Performance Measurement</strong>: Analyze and measure the performance of different models on these key variables.</li>
<li><strong>Prompt Optimization</strong>: Refine the prompt to improve the quality and relevance of the generated SOAP notes.</li>
<li><strong>Model Selection</strong>: Choose the optimal model based on a comprehensive evaluation of performance, cost, and suitability for this specific use case.</li>
<li><strong>Preparedness for New Models</strong>: Develop a framework for immediate analysis and evaluation when new models are released, enabling a clear understanding of the costs and benefits of switching models.</li>
</ul>
<p>Prior to running this notebook, I was using the Claude 3.5 Sonnet model from Anthropic for analyzing the transcriptions and returning a SOAP note as a JSON object. As a result of building and running this notebook, I updated my prompt and switched to a different model. I am also better positioned to immediately evaluate new models released by Anthropic or OpenAI, allowing me to systematically determine the costs and benefits of updating to the latest models.</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FFA198">!</span><span style="color: #C9D1D9">pip install openai</span></span>
<span class="line"><span style="color: #FFA198">!</span><span style="color: #C9D1D9">pip install anthropic</span></span>
<span class="line"><span style="color: #FFA198">!</span><span style="color: #C9D1D9">pip install matplotlib</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> pandas </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> pd</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> matplotlib.pyplot </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> plt</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> os</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> time</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> json</span></span>
<span class="line"><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> openai </span><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> OpenAI</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> anthropic</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> google.colab </span><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> drive</span></span>
<span class="line"><span style="color: #C9D1D9">drive.mount(</span><span style="color: #A5D6FF">'/content/drive'</span><span style="color: #C9D1D9">)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> google.colab </span><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> userdata</span></span>
<span class="line"><span style="color: #79C0FF">OPENAI_API_KEY</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> userdata.get(</span><span style="color: #A5D6FF">'OPENAI_API_KEY'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #79C0FF">ANTHROPIC_API_KEY</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> userdata.get(</span><span style="color: #A5D6FF">'ANTHROPIC_API_KEY'</span><span style="color: #C9D1D9">)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">openai </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> OpenAI(</span><span style="color: #FFA657">api_key</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">OPENAI_API_KEY</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">anthropic </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> anthropic.Anthropic(</span><span style="color: #FFA657">api_key</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">ANTHROPIC_API_KEY</span><span style="color: #C9D1D9">)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">system_content_string </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">f</span><span style="color: #A5D6FF">"""</span></span>
<span class="line"><span style="color: #A5D6FF">You are a helpful, highly-trained medical assistant. Carefully review the following TRANSCRIPT and generate a clinical SOAP note as a JSON object.</span></span>
<span class="line"><span style="color: #A5D6FF">Your answer MUST begin and end with curly brackets. Do not include any leading backticks or other markers. ALL LISTS SHOULD BE UNORDERED AND STYLED WITH A SIMPLE DASH. NO NUMBERED LISTS. Include as much specific information as possible from the transcript in the SOAP note. Be thorough! If you do not have the information required to provide a value in any of the fields, just return the JSON object WITHOUT those fields. Do NOT return a field with an empty string or an "unknown" value. For the differential_diagnosis field, generate a differential diagnosis along with possible alternative treatment options. Your complete answer MUST begin and end with curly brackets.</span></span>
<span class="line"><span style="color: #A5D6FF">"""</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">transcript </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"""</span></span>
<span class="line"><span style="color: #A5D6FF">This patient was seen on July 24th, 2024, time 1536. Patient's name, Josephina Martina. She has no known drug allergies. She's complaining of low back pain. Josephina is a however-year-old female who, who I'm sorry I didn't give you her date of birth date of birth is May 23 1971 Josephina is a however year old female and called today complaining of having sciatic pain since November. She states that she was and has been to physical therapy she was doing better however it has worsened recently causing her to have left left-sided sciatic pain radiating down her left leg she reports of pain as being constant she denies any red flags such as saddle anesthesia, loss of urine or bowel control, and she denies having any weakness to the extremity. prescribed physical therapy, but no other workup for her. She has not had an MRI of her lumbar spine. She is on tenazidine for migraine headaches, but is not on any medication for this. She calls today with an acute flare-up and is requesting to be treated for it until she can get in to see her primary care doctor she denies any abdominal pain dysuria or hematuria she sees she's otherwise healthy she has no known drug allergies and no significant medical problems except for the migraine headaches. Based on her symptomatology and the fact that she is young and otherwise healthy, I will treat her for acute sciatica with lumbar go, but I have recommended that she undergo an MRI of her lumbar spine if she has not had any imaging as she may have a ruptured disc, nerve impingement, or degenerative disc disease. Her diagnosis is acute lumbar go with left-sided sciatica the plan is I have prescribed a medull dose pack to be dispensed per pharmacist no refill flexor all 20 milligram tablets used to take one POB ID PRN muscle spasm and Vicodin 5-3, 25 milligrams. She used to take one to two POQ, four to six hours, PRN pain, dispense 20, no refill."""</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">user_content_string </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">f</span><span style="color: #A5D6FF">"""</span></span>
<span class="line"><span style="color: #A5D6FF">Give me a thorough SOAP note from the following transcript. Return your response as a JSON object. /// TRANSCRIPT: </span><span style="color: #79C0FF">{</span><span style="color: #C9D1D9">transcript</span><span style="color: #79C0FF">}</span><span style="color: #A5D6FF"> """</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">openai_models </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #A5D6FF">'gpt-3.5-turbo'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'gpt-4'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'gpt-4-turbo'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'gpt-4o'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'gpt-4o-mini'</span><span style="color: #C9D1D9">]</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">openai_temperatures </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">]</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">anthropic_models </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #A5D6FF">'claude-3-haiku-20240307'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'claude-3-5-sonnet-20240620'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'claude-3-opus-20240229'</span><span style="color: #C9D1D9">]</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">anthropic_temperatures </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">]</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">iterations </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">10</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">model_pricing </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"gpt-4"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"input_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.03</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"output_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.06</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"gpt-4-turbo"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"input_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.01</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"output_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.03</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"gpt-4o"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"input_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.005</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"output_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.015</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"gpt-4o-mini"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"input_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.00015</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"output_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.0006</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"gpt-3.5-turbo"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"input_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.0005</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"output_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.0015</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"claude-3-haiku-20240307"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"input_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.00025</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"output_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.00125</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"claude-3-5-sonnet-20240620"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"input_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.003</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"output_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.015</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #A5D6FF">"claude-3-opus-20240229"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"input_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.015</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"output_token_cost"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0.075</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span></code></pre>
<p><strong>How to Get Consistent JSON Outputs from LLMs Using Tool Calling</strong></p>
<p>Using a JSON schema is critical in any application that leverages LLMs to transform unstructured data into structured data. Both OpenAI and Anthropic offer ‚Äújson mode‚Äù on their models, but this feature is still highly underutilized or poorly implemented.</p>
<p>Using JSON mode alone will not guarantee the output matches any specific schema, only that it is valid and parses without errors. JSON schemas must be defined in the tool_choice parameter (function calling has been deprecated by OpenAI) and not defined casually in the system prompt.</p>
<p>The cells below show the correct way to define a JSON schema and utilize this object within the tool calling feature for both OpenAI and Anthropic.</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #79C0FF">JSON_schema</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">          </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"object"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">          </span><span style="color: #A5D6FF">"properties"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"appointment_date"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"format"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"date"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"pattern"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"^</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">d</span><span style="color: #79C0FF">{4}</span><span style="color: #A5D6FF">-</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">d</span><span style="color: #79C0FF">{2}</span><span style="color: #A5D6FF">-</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">d</span><span style="color: #79C0FF">{2}</span><span style="color: #A5D6FF">$"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Date of the appointment in yyyy-mm-dd format"</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"appointment_time"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"pattern"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"^</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">d</span><span style="color: #79C0FF">{2}</span><span style="color: #A5D6FF">:</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">d</span><span style="color: #79C0FF">{2}</span><span style="color: #A5D6FF">$"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Time of the appointment in hh:mm format"</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"chief_complaint"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"maxLength"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">50</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Chief complaint. Capitalize the first letter of the string"</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"soap_subjective"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Subjective information from the patient. DO NOT include patient name or date of birth."</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"soap_objective"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Objective observations and measurements. Narrative format or UNORDERED list. DO NOT include patient name or date of birth."</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"soap_assessment"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Assessment and diagnosis. Narrative format or UNORDERED list. NO DIFFERENTIAL DIAGNOSIS in this field."</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"soap_plan"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Plan for treatment and patient education. Narrative format or UNORDERED list."</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"differential_diagnosis"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Differential diagnosis. Narrative format or UNORDERED list."</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"patient_location"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Location of the patient (State/Province, e.g., 'Arizona'). Only include this key if the patient location is clearly mentioned in the transcript."</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">          }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">get_analysis_openai</span><span style="color: #C9D1D9">(system_content_string: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, user_content_string: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, model: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, temperature: </span><span style="color: #79C0FF">float</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1.0</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">f</span><span style="color: #A5D6FF">"calling get_analysis_openai with model: </span><span style="color: #79C0FF">{</span><span style="color: #C9D1D9">model</span><span style="color: #79C0FF">}</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    start_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> time.time()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        response </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> openai.chat.completions.create(</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">model</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">model,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">messages</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span></span>
<span class="line"><span style="color: #C9D1D9">                {</span><span style="color: #A5D6FF">"role"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"system"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"content"</span><span style="color: #C9D1D9">: system_content_string},</span></span>
<span class="line"><span style="color: #C9D1D9">                {</span><span style="color: #A5D6FF">"role"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"user"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"content"</span><span style="color: #C9D1D9">: user_content_string},</span></span>
<span class="line"><span style="color: #C9D1D9">            ],</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">temperature</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">temperature,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">response_format</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">{</span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"json_object"</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">tools</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[{</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"function"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #A5D6FF">"function"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #A5D6FF">"name"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"JSON_soap_note"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">:</span><span style="color: #A5D6FF">"Clinical SOAP note as a JSON object"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #A5D6FF">"parameters"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">JSON_schema</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"><span style="color: #C9D1D9">            }],</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">tool_choice</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">{</span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"function"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"function"</span><span style="color: #C9D1D9">: {</span><span style="color: #A5D6FF">"name"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"JSON_soap_note"</span><span style="color: #C9D1D9">}},</span></span>
<span class="line"><span style="color: #C9D1D9">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        completion_string </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> response.choices[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">].message.tool_calls[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">].function.arguments</span></span>
<span class="line"><span style="color: #C9D1D9">        usage </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> response.usage</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        input_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> usage.prompt_tokens</span></span>
<span class="line"><span style="color: #C9D1D9">        output_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> usage.completion_tokens</span></span>
<span class="line"><span style="color: #C9D1D9">        pricing </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> model_pricing[model]</span></span>
<span class="line"><span style="color: #C9D1D9">        input_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pricing[</span><span style="color: #A5D6FF">'input_token_cost'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        output_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pricing[</span><span style="color: #A5D6FF">'output_token_cost'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        prediction_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ((input_tokens </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> input_cost) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> (output_tokens </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> output_cost))</span></span>
<span class="line"><span style="color: #C9D1D9">        prediction_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> time.time() </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> start_time</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        response_data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">: model,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">: temperature,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'input_tokens'</span><span style="color: #C9D1D9">: input_tokens,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'output_tokens'</span><span style="color: #C9D1D9">: output_tokens,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'input_cost'</span><span style="color: #C9D1D9">: input_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'output_cost'</span><span style="color: #C9D1D9">: output_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'prediction_cost'</span><span style="color: #C9D1D9">: prediction_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'prediction_time'</span><span style="color: #C9D1D9">: prediction_time,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'completion_string'</span><span style="color: #C9D1D9">: completion_string</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E"># Parse completion string</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">            completion_data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> json.loads(completion_string)</span></span>
<span class="line"><span style="color: #C9D1D9">            response_data.update(completion_data)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">except</span><span style="color: #C9D1D9"> json.JSONDecodeError:</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> response_data</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">except</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Exception</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> e:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Error getting OpenAI completion data:"</span><span style="color: #C9D1D9">, e)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> {</span><span style="color: #A5D6FF">'error'</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(e)}</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">model</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'gpt-4o-mini'</span></span>
<span class="line"><span style="color: #C9D1D9">temperature </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">result </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> get_analysis_openai(system_content_string, user_content_string, model, temperature)</span></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(result)</span></span>
<span class="line"></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">calling get_analysis_openai with model: gpt-4o-mini</span></span>
<span class="line"><span style="color: #c9d1d9">{'model': 'gpt-4o-mini', 'temperature': 1, 'input_tokens': 920, 'output_tokens': 297, 'input_cost': 0.00015, 'output_cost': 0.0006, 'prediction_cost': 0.0003162, 'prediction_time': 2.9919168949127197, 'completion_string': '{"appointment_date":"2024-07-24","appointment_time":"15:36","chief_complaint":"Low back pain","soap_subjective":"Josephina is a however-year-old female presenting with complaints of left-sided sciatic pain radiating down her left leg, which has worsened since November. She has been to physical therapy and was doing better, but reports constant pain now. She denies any red flags such as saddle anesthesia, loss of urine or bowel control, and weakness to the extremity. She has no abdominal pain, dysuria, or hematuria. She is otherwise healthy and on tenazidine for migraine headaches.","soap_objective":"- No known drug allergies\\n- No significant medical problems except migraine headaches\\n- No previous MRI of lumbar spine","soap_assessment":"Acute lumbar go with left-sided sciatica","soap_plan":"- Prescribed medull dose pack (no refill)\\n- Flexorall 20 mg tablets, take one PO BID PRN muscle spasm, dispense 20 (no refill)\\n- Vicodin 5-325 mg, take one to two PO Q 4-6 hours PRN pain, dispense 20 (no refill)","differential_diagnosis":"- Ruptured disc\\n- Nerve impingement\\n- Degenerative disc disease\\nPossible alternative treatment options include: - Continue physical therapy - Consider pain management referrals - Evaluate for possible spinal intervention if symptoms persist"}', 'appointment_date': '2024-07-24', 'appointment_time': '15:36', 'chief_complaint': 'Low back pain', 'soap_subjective': 'Josephina is a however-year-old female presenting with complaints of left-sided sciatic pain radiating down her left leg, which has worsened since November. She has been to physical therapy and was doing better, but reports constant pain now. She denies any red flags such as saddle anesthesia, loss of urine or bowel control, and weakness to the extremity. She has no abdominal pain, dysuria, or hematuria. She is otherwise healthy and on tenazidine for migraine headaches.', 'soap_objective': '- No known drug allergies\n- No significant medical problems except migraine headaches\n- No previous MRI of lumbar spine', 'soap_assessment': 'Acute lumbar go with left-sided sciatica', 'soap_plan': '- Prescribed medull dose pack (no refill)\n- Flexorall 20 mg tablets, take one PO BID PRN muscle spasm, dispense 20 (no refill)\n- Vicodin 5-325 mg, take one to two PO Q 4-6 hours PRN pain, dispense 20 (no refill)', 'differential_diagnosis': '- Ruptured disc\n- Nerve impingement\n- Degenerative disc disease\nPossible alternative treatment options include: - Continue physical therapy - Consider pain management referrals - Evaluate for possible spinal intervention if symptoms persist'}</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">get_analysis_anthropic</span><span style="color: #C9D1D9">(system_content_string: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, user_content_string: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, model: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, temperature: </span><span style="color: #79C0FF">float</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1.0</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">f</span><span style="color: #A5D6FF">"calling get_analysis_anthropic with model: </span><span style="color: #79C0FF">{</span><span style="color: #C9D1D9">model</span><span style="color: #79C0FF">}</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    start_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> time.time()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        response </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> anthropic.messages.create(</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">model</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">model,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">messages</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span></span>
<span class="line"><span style="color: #C9D1D9">                {</span><span style="color: #A5D6FF">"role"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"user"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"content"</span><span style="color: #C9D1D9">: user_content_string},</span></span>
<span class="line"><span style="color: #C9D1D9">            ],</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">temperature</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">temperature,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">system</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">system_content_string,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">max_tokens</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">4096</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">tool_choice</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">{</span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"tool"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"name"</span><span style="color: #C9D1D9">:</span><span style="color: #A5D6FF">"JSON_soap_note"</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">tools</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[{</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #A5D6FF">"name"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"JSON_soap_note"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">:</span><span style="color: #A5D6FF">"Clinical SOAP note as a JSON object"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #A5D6FF">"input_schema"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">JSON_schema</span></span>
<span class="line"><span style="color: #C9D1D9">                }]</span></span>
<span class="line"><span style="color: #C9D1D9">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        tool_use_block </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> response.content[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        soap_note </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> tool_use_block.input</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        usage </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> response.usage</span></span>
<span class="line"><span style="color: #C9D1D9">        input_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> usage.input_tokens</span></span>
<span class="line"><span style="color: #C9D1D9">        output_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> usage.output_tokens</span></span>
<span class="line"><span style="color: #C9D1D9">        pricing </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> model_pricing[model]</span></span>
<span class="line"><span style="color: #C9D1D9">        input_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pricing[</span><span style="color: #A5D6FF">'input_token_cost'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        output_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pricing[</span><span style="color: #A5D6FF">'output_token_cost'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        prediction_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ((input_tokens </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> input_cost) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> (output_tokens </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> output_cost))</span></span>
<span class="line"><span style="color: #C9D1D9">        prediction_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> time.time() </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> start_time</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        response_data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">: model,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">: temperature,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'input_tokens'</span><span style="color: #C9D1D9">: input_tokens,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'output_tokens'</span><span style="color: #C9D1D9">: output_tokens,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'input_cost'</span><span style="color: #C9D1D9">: input_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'output_cost'</span><span style="color: #C9D1D9">: output_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'prediction_cost'</span><span style="color: #C9D1D9">: prediction_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'prediction_time'</span><span style="color: #C9D1D9">: prediction_time,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'completion_string'</span><span style="color: #C9D1D9">: json.dumps(soap_note)</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        response_data.update(soap_note)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> response_data</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">except</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Exception</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> e:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Error getting Anthropic completion data:"</span><span style="color: #C9D1D9">, e)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> {</span><span style="color: #A5D6FF">'error'</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(e)}</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">model </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'claude-3-haiku-20240307'</span></span>
<span class="line"><span style="color: #C9D1D9">temperature </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">result </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> get_analysis_anthropic(system_content_string, user_content_string, model, temperature)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(result)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">calling get_analysis_anthropic with model: claude-3-haiku-20240307</span></span>
<span class="line"><span style="color: #c9d1d9">{'model': 'claude-3-haiku-20240307', 'temperature': 1, 'input_tokens': 1460, 'output_tokens': 573, 'input_cost': 0.00025, 'output_cost': 0.00125, 'prediction_cost': 0.00108125, 'prediction_time': 3.445553779602051, 'completion_string': '{"appointment_date": "2024-07-24", "appointment_time": "15:36", "chief_complaint": "Low back pain", "differential_diagnosis": "- Lumbar radiculopathy due to disc herniation\\n- Degenerative disc disease\\n- Piriformis syndrome\\n- Lumbar spinal stenosis", "patient_location": "Unknown", "soap_assessment": "Acute lumbar radiculopathy with left-sided sciatica, likely due to a ruptured or herniated disc. Recommended MRI of the lumbar spine to evaluate for nerve impingement or degenerative disc disease.", "soap_objective": "- 42-year-old female\\n- Complaining of constant left-sided low back and leg pain since November\\n- Denies red flags such as saddle anesthesia, loss of bowel/bladder control, or lower extremity weakness\\n- Has tried physical therapy with some improvement, but symptoms have recently worsened\\n- No significant past medical history except for migraine headaches", "soap_plan": "- Prescribed a medrol dose pack (no refill)\\n- Prescribed flexeril 20mg 1 tab PO BID PRN muscle spasm\\n- Prescribed Vicodin 5-325mg 1-2 tabs PO Q4-6H PRN pain (20 tabs, no refill)\\n- Recommended MRI of the lumbar spine to evaluate for disc herniation or degenerative disease\\n- Advised patient to follow up with primary care provider", "soap_subjective": "The patient is a 42-year-old female who presented with a complaint of low back pain and left-sided sciatica since November. She states the pain is constant and radiating down her left leg. She denies any red flags such as saddle anesthesia, loss of bowel/bladder control, or lower extremity weakness. She has tried physical therapy with some improvement, but her symptoms have recently worsened."}', 'appointment_date': '2024-07-24', 'appointment_time': '15:36', 'chief_complaint': 'Low back pain', 'differential_diagnosis': '- Lumbar radiculopathy due to disc herniation\n- Degenerative disc disease\n- Piriformis syndrome\n- Lumbar spinal stenosis', 'patient_location': 'Unknown', 'soap_assessment': 'Acute lumbar radiculopathy with left-sided sciatica, likely due to a ruptured or herniated disc. Recommended MRI of the lumbar spine to evaluate for nerve impingement or degenerative disc disease.', 'soap_objective': '- 42-year-old female\n- Complaining of constant left-sided low back and leg pain since November\n- Denies red flags such as saddle anesthesia, loss of bowel/bladder control, or lower extremity weakness\n- Has tried physical therapy with some improvement, but symptoms have recently worsened\n- No significant past medical history except for migraine headaches', 'soap_plan': '- Prescribed a medrol dose pack (no refill)\n- Prescribed flexeril 20mg 1 tab PO BID PRN muscle spasm\n- Prescribed Vicodin 5-325mg 1-2 tabs PO Q4-6H PRN pain (20 tabs, no refill)\n- Recommended MRI of the lumbar spine to evaluate for disc herniation or degenerative disease\n- Advised patient to follow up with primary care provider', 'soap_subjective': 'The patient is a 42-year-old female who presented with a complaint of low back pain and left-sided sciatica since November. She states the pain is constant and radiating down her left leg. She denies any red flags such as saddle anesthesia, loss of bowel/bladder control, or lower extremity weakness. She has tried physical therapy with some improvement, but her symptoms have recently worsened.'}</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">results_anthropic </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> model </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> anthropic_models:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> temperature </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> anthropic_temperatures:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _ </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(iterations):</span></span>
<span class="line"><span style="color: #C9D1D9">            result </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> get_analysis_anthropic(system_content_string, user_content_string, model, temperature)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> result:</span></span>
<span class="line"><span style="color: #C9D1D9">                results_anthropic.append(result)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Convert results to a DataFrame</span></span>
<span class="line"><span style="color: #C9D1D9">df_results_anthropic </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.DataFrame(results_anthropic)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Save to csv</span></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> os.path.exists(</span><span style="color: #A5D6FF">'results-anthropic.csv'</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    df_results_anthropic.to_csv(</span><span style="color: #A5D6FF">'results-anthropic.csv'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">mode</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'a'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">header</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">index</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #FF7B72">else</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">    df_results_anthropic.to_csv(</span><span style="color: #A5D6FF">'results-anthropic.csv'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">index</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">results_openai </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> model </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> openai_models:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> temperature </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> openai_temperatures:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _ </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(iterations):</span></span>
<span class="line"><span style="color: #C9D1D9">            result </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> get_analysis_openai(system_content_string, user_content_string, model, temperature)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> result:</span></span>
<span class="line"><span style="color: #C9D1D9">                results_openai.append(result)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Convert results to a DataFrame</span></span>
<span class="line"><span style="color: #C9D1D9">df_results_openai </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.DataFrame(results_openai)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Save to csv</span></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> os.path.exists(</span><span style="color: #A5D6FF">'results-openai.csv'</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    df_results_openai.to_csv(</span><span style="color: #A5D6FF">'results-openai.csv'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">mode</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'a'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">header</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">index</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #FF7B72">else</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">    df_results_openai.to_csv(</span><span style="color: #A5D6FF">'results-openai.csv'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">index</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span></code></pre>
<h2 id="prediction-analysis"><strong>PREDICTION ANALYSIS</strong></h2>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> google.colab </span><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> drive</span></span>
<span class="line"><span style="color: #C9D1D9">drive.mount(</span><span style="color: #A5D6FF">'/content/drive'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">df </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.read_csv(</span><span style="color: #A5D6FF">'/content/drive/MyDrive/soapnotescribe/combined-results.csv'</span><span style="color: #C9D1D9">)</span></span></code></pre>
<h2 id="analysis-prediction-time"><strong>Analysis: Prediction Time</strong></h2>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">avg_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby(</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)[</span><span style="color: #A5D6FF">'prediction_time'</span><span style="color: #C9D1D9">].mean().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_time'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby(</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)[</span><span style="color: #A5D6FF">'prediction_time'</span><span style="color: #C9D1D9">].agg([</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]).reset_index()</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(grouped_time, avg_time, </span><span style="color: #FFA657">left_on</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">right_on</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_time.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_time'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_time)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                        model        min        max   avg_time</span></span>
<span class="line"><span style="color: #c9d1d9">3               gpt-3.5-turbo   2.403372   4.903928   3.326057</span></span>
<span class="line"><span style="color: #c9d1d9">1     claude-3-haiku-20240307   2.904863   3.945817   3.482712</span></span>
<span class="line"><span style="color: #c9d1d9">6                 gpt-4o-mini   2.723844   5.356143   3.798611</span></span>
<span class="line"><span style="color: #c9d1d9">5                      gpt-4o   3.496561   9.293203   4.771959</span></span>
<span class="line"><span style="color: #c9d1d9">0  claude-3-5-sonnet-20240620   6.731199  10.581660   8.532432</span></span>
<span class="line"><span style="color: #c9d1d9">4                 gpt-4-turbo   8.035556  18.641133  12.851380</span></span>
<span class="line"><span style="color: #c9d1d9">2      claude-3-opus-20240229  17.476052  24.618349  20.815876</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">plt.figure(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i, row </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> grouped_time.iterrows():</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot([row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">]], [row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]], </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'black'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'-'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">marker</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'o'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'ro'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Max'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'avg_time'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'go'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Avg'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'bo'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Min'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.xlabel(</span><span style="color: #A5D6FF">'Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.ylabel(</span><span style="color: #A5D6FF">'Prediction Time (seconds)'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.title(</span><span style="color: #A5D6FF">'Min, Average, and Max Prediction Times (seconds) by Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.xticks(</span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">45</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'best'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_29_0.png" alt="png"></p>
<p><strong>Conclusions: Prediction Time</strong></p>
<ul>
<li>Claude-3-opus and gpt-4-turbo are highly variable and both take the longest.</li>
</ul>
<p>Models with best prediction times:</p>
<ul>
<li>gpt-3.5-turbo</li>
<li>claude-3-haiku (least variable)</li>
<li>gpt-4o-mini</li>
</ul>
<h2 id="analysis-prediction-cost"><strong>Analysis: Prediction Cost</strong></h2>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">avg_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby(</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)[</span><span style="color: #A5D6FF">'prediction_cost'</span><span style="color: #C9D1D9">].mean().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby(</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)[</span><span style="color: #A5D6FF">'prediction_cost'</span><span style="color: #C9D1D9">].agg([</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]).reset_index()</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(grouped_cost, avg_cost, </span><span style="color: #FFA657">left_on</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">right_on</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_cost.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_cost)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                        model       min       max       avg</span></span>
<span class="line"><span style="color: #c9d1d9">6                 gpt-4o-mini  0.000318  0.000402  0.000358</span></span>
<span class="line"><span style="color: #c9d1d9">3               gpt-3.5-turbo  0.000847  0.001032  0.000936</span></span>
<span class="line"><span style="color: #c9d1d9">1     claude-3-haiku-20240307  0.000951  0.001081  0.001004</span></span>
<span class="line"><span style="color: #c9d1d9">5                      gpt-4o  0.008860  0.010990  0.009821</span></span>
<span class="line"><span style="color: #c9d1d9">0  claude-3-5-sonnet-20240620  0.012213  0.014403  0.013255</span></span>
<span class="line"><span style="color: #c9d1d9">4                 gpt-4-turbo  0.018320  0.022490  0.020131</span></span>
<span class="line"><span style="color: #c9d1d9">2      claude-3-opus-20240229  0.057090  0.072765  0.061650</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">plt.figure(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i, row </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> grouped_cost.iterrows():</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot([row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">]], [row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]], </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'black'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'-'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">marker</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'o'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'ro'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Max'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'avg'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'go'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Avg'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'bo'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Min'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.xlabel(</span><span style="color: #A5D6FF">'Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.ylabel(</span><span style="color: #A5D6FF">'Prediction Cost $'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.title(</span><span style="color: #A5D6FF">'Min, Average, and Max Prediction Costs ($) by Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.xticks(</span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">45</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'best'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_33_0.png" alt="png"></p>
<h2 id="analysis-prediction-cost-with-model-temperature"><strong>Analysis: Prediction Cost with Model Temperature</strong></h2>
<p>What impact does changing the temperature have on cost?</p>
<p>Lower temp value = more deterministic output</p>
<p>Are more deterministic outputs more consistent in price range?</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Calculate average cost, grouping by both model and temperature</span></span>
<span class="line"><span style="color: #C9D1D9">avg_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'prediction_cost'</span><span style="color: #C9D1D9">].mean().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Calculate min and max costs, grouping by both model and temperature</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'prediction_cost'</span><span style="color: #C9D1D9">].agg([</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]).reset_index()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Merge the grouped cost with the average cost</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(grouped_cost, avg_cost, </span><span style="color: #FFA657">on</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Append temperature to the model name</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_cost[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">' (T='</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> grouped_cost[</span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">].astype(</span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">')'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_cost.drop(</span><span style="color: #FFA657">columns</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Sort the DataFrame by avg cost in ascending order</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_cost.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_cost)</span></span>
<span class="line"></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                                 model       min       max       avg</span></span>
<span class="line"><span style="color: #c9d1d9">13                 gpt-4o-mini (T=1.0)  0.000338  0.000402  0.000357</span></span>
<span class="line"><span style="color: #c9d1d9">12                 gpt-4o-mini (T=0.7)  0.000318  0.000396  0.000359</span></span>
<span class="line"><span style="color: #c9d1d9">7                gpt-3.5-turbo (T=1.0)  0.000847  0.001003  0.000934</span></span>
<span class="line"><span style="color: #c9d1d9">6                gpt-3.5-turbo (T=0.7)  0.000862  0.001032  0.000938</span></span>
<span class="line"><span style="color: #c9d1d9">2      claude-3-haiku-20240307 (T=0.7)  0.000951  0.001081  0.000995</span></span>
<span class="line"><span style="color: #c9d1d9">3      claude-3-haiku-20240307 (T=1.0)  0.000960  0.001058  0.001013</span></span>
<span class="line"><span style="color: #c9d1d9">10                      gpt-4o (T=0.7)  0.008860  0.010990  0.009725</span></span>
<span class="line"><span style="color: #c9d1d9">11                      gpt-4o (T=1.0)  0.009445  0.010720  0.009916</span></span>
<span class="line"><span style="color: #c9d1d9">1   claude-3-5-sonnet-20240620 (T=1.0)  0.012213  0.014403  0.013208</span></span>
<span class="line"><span style="color: #c9d1d9">0   claude-3-5-sonnet-20240620 (T=0.7)  0.012303  0.014178  0.013302</span></span>
<span class="line"><span style="color: #c9d1d9">9                  gpt-4-turbo (T=1.0)  0.018320  0.021290  0.020021</span></span>
<span class="line"><span style="color: #c9d1d9">8                  gpt-4-turbo (T=0.7)  0.018410  0.022490  0.020240</span></span>
<span class="line"><span style="color: #c9d1d9">5       claude-3-opus-20240229 (T=1.0)  0.057915  0.066465  0.061282</span></span>
<span class="line"><span style="color: #c9d1d9">4       claude-3-opus-20240229 (T=0.7)  0.057090  0.072765  0.062018</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">plt.figure(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i, row </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> grouped_cost.iterrows():</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot([row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">]], [row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]], </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'black'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'-'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">marker</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'o'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'ro'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Max'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'avg'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'go'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Avg'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'bo'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Min'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.xlabel(</span><span style="color: #A5D6FF">'Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.ylabel(</span><span style="color: #A5D6FF">'Prediction Cost $'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.title(</span><span style="color: #A5D6FF">'Min, Average, and Max Prediction Costs ($) by Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.xticks(</span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">90</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'best'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_36_0.png" alt="png"></p>
<p><strong>Conclusions: Prediction Cost</strong></p>
<p>Adjusting the temperature from 1.0 to 0.7 does not lead to a significant or consistent change in prediction cost.</p>
<p>Running this analysis on the given models revealed what appears to be four different pricing tiers:</p>
<p>Lowest:</p>
<ul>
<li>gpt-4o-mini</li>
<li>gpt-3.5-turbo</li>
<li>claude-3-haiku</li>
</ul>
<p>Medium:</p>
<ul>
<li>gpt-4o</li>
<li>claude-3.5-sonnet</li>
</ul>
<p>High:</p>
<ul>
<li>gpt-4-turbo</li>
</ul>
<p>Highest:</p>
<ul>
<li>claude-3-opus</li>
</ul>
<p>Cost conclusions:
Claude-3-opus is an outlier in high cost. Widest cost range (highly variable output length). A lower temperature means the output is more deterministic, but on this model the cost is even more varied at a temperarute of 0.7 than 1.0.</p>
<p>Models with best pricing:</p>
<ul>
<li>gpt-4o-mini</li>
<li>gpt-3.5-turbo</li>
<li>claude-3-haiku</li>
</ul>
<h2 id="analysis-output-tokens"><strong>Analysis: Output Tokens</strong></h2>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">avg_output_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby(</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)[</span><span style="color: #A5D6FF">'output_tokens'</span><span style="color: #C9D1D9">].mean().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_output'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby(</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)[</span><span style="color: #A5D6FF">'output_tokens'</span><span style="color: #C9D1D9">].agg([</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]).reset_index()</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(grouped_output, avg_output_tokens, </span><span style="color: #FFA657">left_on</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">right_on</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_output'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_output)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">plt.figure(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i, row </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> grouped_output.iterrows():</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot([row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">]], [row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]], </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'black'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'-'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">marker</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'o'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'ro'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Max'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'avg_output'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'go'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Avg'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'bo'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Min'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.xlabel(</span><span style="color: #A5D6FF">'Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.ylabel(</span><span style="color: #A5D6FF">'Output Tokens'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.title(</span><span style="color: #A5D6FF">'Min, Max, and Average Output Tokens by Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.xticks(</span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">45</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'best'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_40_0.png" alt="png"></p>
<p><strong>Output Token with Model Temperature</strong></p>
<p>What impact does changing the temperature have on output tokens?</p>
<p>Lower temp value = more deterministic output</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">avg_output_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'output_tokens'</span><span style="color: #C9D1D9">].mean().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_output'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'output_tokens'</span><span style="color: #C9D1D9">].agg([</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]).reset_index()</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(grouped_output, avg_output_tokens, </span><span style="color: #FFA657">on</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">' (T='</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">].astype(</span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">')'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.drop(</span><span style="color: #FFA657">columns</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_output'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_output)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                                 model  min  max  avg_output</span></span>
<span class="line"><span style="color: #c9d1d9">7                gpt-3.5-turbo (T=1.0)  253  357       311.2</span></span>
<span class="line"><span style="color: #c9d1d9">6                gpt-3.5-turbo (T=0.7)  263  376       313.5</span></span>
<span class="line"><span style="color: #c9d1d9">10                      gpt-4o (T=0.7)  284  426       341.7</span></span>
<span class="line"><span style="color: #c9d1d9">11                      gpt-4o (T=1.0)  323  408       354.4</span></span>
<span class="line"><span style="color: #c9d1d9">9                  gpt-4-turbo (T=1.0)  299  398       355.7</span></span>
<span class="line"><span style="color: #c9d1d9">8                  gpt-4-turbo (T=0.7)  302  438       363.0</span></span>
<span class="line"><span style="color: #c9d1d9">13                 gpt-4o-mini (T=1.0)  334  440       365.7</span></span>
<span class="line"><span style="color: #c9d1d9">12                 gpt-4o-mini (T=0.7)  300  430       368.7</span></span>
<span class="line"><span style="color: #c9d1d9">2      claude-3-haiku-20240307 (T=0.7)  469  573       504.0</span></span>
<span class="line"><span style="color: #c9d1d9">3      claude-3-haiku-20240307 (T=1.0)  476  554       518.2</span></span>
<span class="line"><span style="color: #c9d1d9">5       claude-3-opus-20240229 (T=1.0)  492  606       536.9</span></span>
<span class="line"><span style="color: #c9d1d9">4       claude-3-opus-20240229 (T=0.7)  481  690       546.7</span></span>
<span class="line"><span style="color: #c9d1d9">1   claude-3-5-sonnet-20240620 (T=1.0)  538  684       604.3</span></span>
<span class="line"><span style="color: #c9d1d9">0   claude-3-5-sonnet-20240620 (T=0.7)  544  669       610.6</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">plt.figure(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i, row </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> grouped_output.iterrows():</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot([row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">]], [row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]], </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'black'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'-'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">marker</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'o'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'ro'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Max'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'avg_output'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'go'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Avg'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'bo'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Min'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.xlabel(</span><span style="color: #A5D6FF">'Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.ylabel(</span><span style="color: #A5D6FF">'Output Tokens'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.title(</span><span style="color: #A5D6FF">'Min, Max, and Average Output Tokens by Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.xticks(</span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">90</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'best'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_43_0.png" alt="png"></p>
<p><strong>Output Token Conclusions</strong></p>
<ul>
<li>Anthropic Claude models are all more verbose than OpenAI gpt models (given exact same prompt and JSON schema).</li>
<li>Changing temperature does not have clear impact on output token length</li>
<li>Why are Anthropic outputs longer? Inclusion of differential diagnosis or other content field?</li>
</ul>
<p>Models with output token preference:</p>
<ul>
<li>Not applicable. Longer/shorter is not necessarily better.</li>
</ul>
<h2 id="analysis-inclusion-of-differential-diagnosis-with-alternative-treatment"><strong>Analysis: Inclusion of Differential Diagnosis with Alternative Treatment</strong></h2>
<ul>
<li>Was a Differential Diagnosis returned?</li>
<li>How many Differential Diagnosis values included ‚Äúalternative treatments‚Äù as requested in the system prompt?</li>
</ul>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Function to calculate the length of differential diagnosis or zero if empty</span></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">diagnosis_length</span><span style="color: #C9D1D9">(diagnosis: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(diagnosis) </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> diagnosis </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'differential_diagnosis'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'differential_diagnosis'</span><span style="color: #C9D1D9">].fillna(</span><span style="color: #A5D6FF">''</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Add a new column for the length of differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'diff_diag_length'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'differential_diagnosis'</span><span style="color: #C9D1D9">].apply(diagnosis_length)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Count the number of rows with a non-empty differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'has_diff_diag'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'differential_diagnosis'</span><span style="color: #C9D1D9">].apply(</span><span style="color: #FF7B72">lambda</span><span style="color: #C9D1D9"> x: </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Check if 'alternative' is in the differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'has_alternative'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'differential_diagnosis'</span><span style="color: #C9D1D9">].apply(</span><span style="color: #FF7B72">lambda</span><span style="color: #C9D1D9"> x: </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'alternative'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> x.lower() </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Calculate the average length of differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">avg_diff_length </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'diff_diag_length'</span><span style="color: #C9D1D9">].mean().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_diff_length'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Count the number of rows with a non-empty differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">total_diff_diag </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'has_diff_diag'</span><span style="color: #C9D1D9">].sum().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'total_diff_diag'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Count the number of rows with 'alternative' in the differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">total_alternative </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'has_alternative'</span><span style="color: #C9D1D9">].sum().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'total_alternative'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Merge the results</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(avg_diff_length, total_diff_diag, </span><span style="color: #FFA657">on</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(grouped_output, total_alternative, </span><span style="color: #FFA657">on</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Append temperature to the model name</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">' (T='</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">].astype(</span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">')'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Drop the temperature column</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.drop(</span><span style="color: #FFA657">columns</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Sort the DataFrame by avg_diff_length in ascending order</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_diff_length'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_output)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                                 model  avg_diff_length  total_diff_diag  \</span></span>
<span class="line"><span style="color: #c9d1d9">10                      gpt-4o (T=0.7)            143.6               10</span></span>
<span class="line"><span style="color: #c9d1d9">0   claude-3-5-sonnet-20240620 (T=0.7)            150.5               10</span></span>
<span class="line"><span style="color: #c9d1d9">11                      gpt-4o (T=1.0)            158.0               10</span></span>
<span class="line"><span style="color: #c9d1d9">2      claude-3-haiku-20240307 (T=0.7)            165.2               10</span></span>
<span class="line"><span style="color: #c9d1d9">6                gpt-3.5-turbo (T=0.7)            175.5                8</span></span>
<span class="line"><span style="color: #c9d1d9">3      claude-3-haiku-20240307 (T=1.0)            216.1               10</span></span>
<span class="line"><span style="color: #c9d1d9">7                gpt-3.5-turbo (T=1.0)            218.4                9</span></span>
<span class="line"><span style="color: #c9d1d9">12                 gpt-4o-mini (T=0.7)            219.1               10</span></span>
<span class="line"><span style="color: #c9d1d9">4       claude-3-opus-20240229 (T=0.7)            222.3               10</span></span>
<span class="line"><span style="color: #c9d1d9">5       claude-3-opus-20240229 (T=1.0)            223.9               10</span></span>
<span class="line"><span style="color: #c9d1d9">13                 gpt-4o-mini (T=1.0)            236.6               10</span></span>
<span class="line"><span style="color: #c9d1d9">1   claude-3-5-sonnet-20240620 (T=1.0)            251.7               10</span></span>
<span class="line"><span style="color: #c9d1d9">8                  gpt-4-turbo (T=0.7)            260.4               10</span></span>
<span class="line"><span style="color: #c9d1d9">9                  gpt-4-turbo (T=1.0)            261.7               10</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    total_alternative</span></span>
<span class="line"><span style="color: #c9d1d9">10                  4</span></span>
<span class="line"><span style="color: #c9d1d9">0                   1</span></span>
<span class="line"><span style="color: #c9d1d9">11                  2</span></span>
<span class="line"><span style="color: #c9d1d9">2                   3</span></span>
<span class="line"><span style="color: #c9d1d9">6                   3</span></span>
<span class="line"><span style="color: #c9d1d9">3                   2</span></span>
<span class="line"><span style="color: #c9d1d9">7                   5</span></span>
<span class="line"><span style="color: #c9d1d9">12                  8</span></span>
<span class="line"><span style="color: #c9d1d9">4                   3</span></span>
<span class="line"><span style="color: #c9d1d9">5                   5</span></span>
<span class="line"><span style="color: #c9d1d9">13                  9</span></span>
<span class="line"><span style="color: #c9d1d9">1                   3</span></span>
<span class="line"><span style="color: #c9d1d9">8                   9</span></span>
<span class="line"><span style="color: #c9d1d9">9                   4</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"></span>
<span class="line"><span style="color: #8B949E"># Plotting the data</span></span>
<span class="line"><span style="color: #C9D1D9">fig, ax1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> plt.subplots(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Bar chart for total differentials</span></span>
<span class="line"><span style="color: #C9D1D9">bar1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ax1.bar(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], grouped_output[</span><span style="color: #A5D6FF">'total_diff_diag'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Total Differential Diagnoses Returned'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'skyblue'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">edgecolor</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'skyblue'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Bar chart for differentials that include "alternative"</span></span>
<span class="line"><span style="color: #C9D1D9">bar2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ax1.bar(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], grouped_output[</span><span style="color: #A5D6FF">'total_alternative'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Differentials included alternative treatment'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'lightcoral'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Secondary y-axis for average differential diagnosis length</span></span>
<span class="line"><span style="color: #C9D1D9">ax2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ax1.twinx()</span></span>
<span class="line"><span style="color: #C9D1D9">ax2.plot(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], grouped_output[</span><span style="color: #A5D6FF">'avg_diff_length'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'green'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">marker</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'o'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">''</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linewidth</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">markersize</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Average Differential Diagnosis Length'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Customizing the plot</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xlabel(</span><span style="color: #A5D6FF">'Model (Temperature)'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_ylabel(</span><span style="color: #A5D6FF">'Number of Differential Diagnoses Returned'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax2.set_ylabel(</span><span style="color: #A5D6FF">'Average Differential Diagnosis Length (characters)'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_title(</span><span style="color: #A5D6FF">'Inclusion of Differential Diagnosis by Model and Temperature'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xticks(</span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">])))</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xticklabels(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">45</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ha</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'right'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'upper left'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">bbox_to_anchor</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0.0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1.15</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">ncol</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax2.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'upper right'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">bbox_to_anchor</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1.0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1.15</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">ncol</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Display the plot</span></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_48_0.png" alt="png"></p>
<p><strong>Conclusions: Inclusion of Differential Diagnosis with Alternative Treatment</strong></p>
<ul>
<li>Results are highly varied across models. Difficult to draw conclusions about model capabilities. gpt-4-turbo may be better at writing a detailed differential diagnosis, but how would the other models perform if asked to do this task with more specific detail? gpt-4o-mini may be better at following system prompt instructions and including an alternative treatment, but how would the other models perform if this requirement was made more explicit?</li>
<li>While Claude models tend to return more total output tokens, this is not solely due to greater length or frequency of including a differential diagnosis.</li>
<li>Update system prompt and JSON schema to better direct all models to include Differential Diagnosis with alternative treatment options.</li>
</ul>
<h2 id="analysis-fixing-transcription-errors"><strong>Analysis: Fixing Transcription Errors</strong></h2>
<p>The transcript includes the text ‚ÄúVicodin 5-3, 25 milligrams‚Äù for when the speaker said ‚ÄúVicodin five slash three twenty-five milligrams.‚Äù This should have been transcribed as ‚ÄúVicodin 5/325 milligrams.‚Äù</p>
<p>The dosage of medications is typically written with a slash (‚Äù/‚Äù) to clearly separate the amounts of each ingredient. ‚Äú5‚Äù represents the amount of hydrocodone (usually in milligrams), and ‚Äú325‚Äù represents the amount of acetaminophen (also in milligrams).
‚ÄúVicodin 5/325‚Äù means each tablet contains 5 mg of hydrocodone and 325 mg of acetaminophen.</p>
<p>The transcript also includes a spelling error related to a medication name: ‚Äúflexor all 20 milligram tablets‚Äù should be ‚ÄúFlexeril 20 milligram tablets‚Äù.</p>
<p>While this was not specifically requested in the prompt, some of the models caught these mistakes in the transcript and automatically fixed them in the response.</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Function to calculate whether the soap_plan includes the text 5/325</span></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">check_formatting</span><span style="color: #C9D1D9">(soap_plan: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"5/325"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> soap_plan </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Function to calculate whether the soap_plan includes the text flexeril</span></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">check_spelling</span><span style="color: #C9D1D9">(soap_plan: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"flexeril"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> soap_plan.lower() </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Add a new column to store whether soap_plan includes corrrect formatting of 5/325</span></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'corrected_formatting'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'soap_plan'</span><span style="color: #C9D1D9">].apply(check_formatting)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Add a new column to store whether soap_plan includes corrected spelling of flexeril</span></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'corrected_spelling'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'soap_plan'</span><span style="color: #C9D1D9">].apply(check_spelling)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Count the number of rows with correct formatting</span></span>
<span class="line"><span style="color: #C9D1D9">total_formatted </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'corrected_formatting'</span><span style="color: #C9D1D9">].sum().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'total_formatted'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Count the number of rows with correct spelling</span></span>
<span class="line"><span style="color: #C9D1D9">total_spelling </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'corrected_spelling'</span><span style="color: #C9D1D9">].sum().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'total_spelling'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Merge the results ()</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(total_formatted, total_spelling, </span><span style="color: #FFA657">on</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">how</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'inner'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Append temperature to the model name</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">' (T='</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">].astype(</span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">')'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Drop the temperature column</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.drop(</span><span style="color: #FFA657">columns</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Sort the DataFrame by total_formatted in ascending order</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'total_formatted'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_output)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                                 model  total_formatted  total_spelling</span></span>
<span class="line"><span style="color: #c9d1d9">0   claude-3-5-sonnet-20240620 (T=0.7)                0              10</span></span>
<span class="line"><span style="color: #c9d1d9">1   claude-3-5-sonnet-20240620 (T=1.0)                0              10</span></span>
<span class="line"><span style="color: #c9d1d9">2      claude-3-haiku-20240307 (T=0.7)                0              10</span></span>
<span class="line"><span style="color: #c9d1d9">6                gpt-3.5-turbo (T=0.7)                0               3</span></span>
<span class="line"><span style="color: #c9d1d9">8                  gpt-4-turbo (T=0.7)                0               4</span></span>
<span class="line"><span style="color: #c9d1d9">12                 gpt-4o-mini (T=0.7)                0              10</span></span>
<span class="line"><span style="color: #c9d1d9">13                 gpt-4o-mini (T=1.0)                0              10</span></span>
<span class="line"><span style="color: #c9d1d9">7                gpt-3.5-turbo (T=1.0)                1               4</span></span>
<span class="line"><span style="color: #c9d1d9">9                  gpt-4-turbo (T=1.0)                2               5</span></span>
<span class="line"><span style="color: #c9d1d9">3      claude-3-haiku-20240307 (T=1.0)                3              10</span></span>
<span class="line"><span style="color: #c9d1d9">4       claude-3-opus-20240229 (T=0.7)                3              10</span></span>
<span class="line"><span style="color: #c9d1d9">5       claude-3-opus-20240229 (T=1.0)                3              10</span></span>
<span class="line"><span style="color: #c9d1d9">11                      gpt-4o (T=1.0)                7              10</span></span>
<span class="line"><span style="color: #c9d1d9">10                      gpt-4o (T=0.7)                9              10</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"></span>
<span class="line"><span style="color: #8B949E"># Plotting the data</span></span>
<span class="line"><span style="color: #C9D1D9">fig, ax1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> plt.subplots(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">bar_width </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0.35</span></span>
<span class="line"><span style="color: #C9D1D9">opacity </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0.8</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Bar chart for total corrected values</span></span>
<span class="line"><span style="color: #C9D1D9">bar1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ax1.bar(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], grouped_output[</span><span style="color: #A5D6FF">'total_formatted'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">width</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">bar_width, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Corrected Medication Formatting'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'skyblue'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">edgecolor</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'skyblue'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">bar2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ax1.bar([x </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> bar_width </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">]))], grouped_output[</span><span style="color: #A5D6FF">'total_spelling'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">width</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">bar_width, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Corrected Medication Spelling'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'lightcoral'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Customizing the plot</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xlabel(</span><span style="color: #A5D6FF">'Model (Temperature)'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_ylabel(</span><span style="color: #A5D6FF">'Number of Corrections Made'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_title(</span><span style="color: #A5D6FF">'Correction of Transcription Errors'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xticks(</span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">])))</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xticklabels(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">90</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ha</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'right'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'upper left'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">bbox_to_anchor</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0.0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1.15</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">ncol</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Display the plot</span></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_54_0.png" alt="png"></p>
<p><strong>Conclusions: Fixing Transcription Errore</strong></p>
<ul>
<li>Results are highly varied across models. Difficult to draw conclusions about model capabilities. gpt-4o may be better at fixing transcriptions errors but this behavior was not specifically requested.</li>
<li>Changing the temperature between 0.7 and 1.0 does not appear to have a direct impact on transcription error correction outcomes.</li>
<li>Update system prompt and JSON schema to specifically request fixing medication transcription errors.</li>
</ul>
<h2 id="prompt-revision"><strong>PROMPT REVISION</strong></h2>
<ul>
<li>
<p>Update system_prompt and JSON_schema: Response MUST include Differential Diagnosis with an alternative treatment plan.</p>
</li>
<li>
<p>Update system_prompt and JSON_schema: Transcripts are likely to include errors. Specify that you want the model to fix prescription names and formatting.</p>
</li>
<li>
<p>Set minimum length for each response field to ensure longer responses? Could have negative consequences. Will this force the model to make something up if the information is not in the transcript? Decide to pass on this for now.</p>
</li>
<li>
<p>Drop claude-3-opus: expensive.</p>
</li>
</ul>
<p>Update JSON schema:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #79C0FF">JSON_schema_obj</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">          </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"object"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">          </span><span style="color: #A5D6FF">"properties"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"appointment_date"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"format"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"date"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"pattern"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"^</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">d</span><span style="color: #79C0FF">{4}</span><span style="color: #A5D6FF">-</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">d</span><span style="color: #79C0FF">{2}</span><span style="color: #A5D6FF">-</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">d</span><span style="color: #79C0FF">{2}</span><span style="color: #A5D6FF">$"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Date of the appointment in yyyy-mm-dd format"</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"appointment_time"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"pattern"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"^</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">d</span><span style="color: #79C0FF">{2}</span><span style="color: #A5D6FF">:</span><span style="color: #79C0FF">\\</span><span style="color: #A5D6FF">d</span><span style="color: #79C0FF">{2}</span><span style="color: #A5D6FF">$"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Time of the appointment in hh:mm format"</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"chief_complaint"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Chief complaint. Capitalize the first letter of the string"</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"soap_subjective"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"minLength"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">550</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Subjective information from the patient. DO NOT include patient name or date of birth."</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"soap_objective"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"minLength"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">100</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Objective observations and measurements. Narrative format or UNORDERED list. DO NOT include patient name or date of birth."</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"soap_assessment"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Assessment and diagnosis. Narrative format or UNORDERED list. NO DIFFERENTIAL DIAGNOSIS in this field."</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"soap_plan"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"minLength"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">250</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Plan for treatment and patient education. Narrative format or UNORDERED list. Be sure to correct spelling and formatting of medications."</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"differential_diagnosis"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"minLength"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">140</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Differential diagnosis and alternative treatment plan. Narrative format or UNORDERED list. ALWAYS INCLUDE."</span></span>
<span class="line"><span style="color: #C9D1D9">            },</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">"patient_location"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">              </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"Location of the patient (State/Province, e.g., 'Arizona'). Only include this key if the patient location is clearly mentioned in the transcript."</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">          }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span></code></pre>
<p>Update system content string to specify differential diagnosis will be generated; medication spelling and formatting may need to be corrected:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">system_content_string </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"""</span></span>
<span class="line"><span style="color: #A5D6FF">As a highly skilled medical assistant, your task is to meticulously review the provided TRANSCRIPT and craft a clinical SOAP note in the form of a JSON object. Please adhere strictly to the following guidelines:</span></span>
<span class="line"><span style="color: #A5D6FF">- Ensure all lists within the SOAP note are unordered, formatted with a simple dash (-). Avoid using numbered lists.</span></span>
<span class="line"><span style="color: #A5D6FF">- Incorporate as much detailed information as possible from the transcript into the SOAP note. Thoroughness is key!</span></span>
<span class="line"><span style="color: #A5D6FF">- If certain information required for any fields is missing from the transcript, exclude those fields from the JSON object entirely. Do not include fields with empty strings or "unknown" values.</span></span>
<span class="line"><span style="color: #A5D6FF">- The transcript may not explicitly mention differential diagnoses. As an expert, you are expected to formulate a differential diagnosis based on the transcript information. Always include a differential diagnosis along with alternative treatment recommendations in your SOAP note.</span></span>
<span class="line"><span style="color: #A5D6FF">- Be vigilant for formatting and spelling errors in the transcript, particularly regarding prescription medications. Correct these errors accurately. Pay special attention to the spelling and formatting of any prescription medications mentioned.</span></span>
<span class="line"><span style="color: #A5D6FF">Your expertise and attention to detail will ensure the generation of a comprehensive and accurate SOAP note.</span></span>
<span class="line"><span style="color: #A5D6FF">"""</span></span></code></pre>
<p>Create a new param to track prompt version updates:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">prompt_version </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">openai_models </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #A5D6FF">'gpt-3.5-turbo'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'gpt-4-turbo'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'gpt-4o'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'gpt-4o-mini'</span><span style="color: #C9D1D9">]</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">openai_temperatures </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">]</span></span></code></pre>
<p>Drop Anthropic Claude model:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">anthropic_models </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #A5D6FF">'claude-3-haiku-20240307'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'claude-3-5-sonnet-20240620'</span><span style="color: #C9D1D9">]</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">anthropic_temperatures </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">]</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">iterations </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">10</span></span></code></pre>
<p>Update OpenAI API call function to take prompt_version param:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">get_analysis_openai</span><span style="color: #C9D1D9">(system_content_string: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, user_content_string: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, model: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, temperature: </span><span style="color: #79C0FF">float</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1.0</span><span style="color: #C9D1D9">, prompt_version: </span><span style="color: #79C0FF">int</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">f</span><span style="color: #A5D6FF">"calling get_analysis_openai with model: </span><span style="color: #79C0FF">{</span><span style="color: #C9D1D9">model</span><span style="color: #79C0FF">}</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    start_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> time.time()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        response </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> openai.chat.completions.create(</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">model</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">model,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">messages</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span></span>
<span class="line"><span style="color: #C9D1D9">                {</span><span style="color: #A5D6FF">"role"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"system"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"content"</span><span style="color: #C9D1D9">: system_content_string},</span></span>
<span class="line"><span style="color: #C9D1D9">                {</span><span style="color: #A5D6FF">"role"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"user"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"content"</span><span style="color: #C9D1D9">: user_content_string},</span></span>
<span class="line"><span style="color: #C9D1D9">            ],</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">temperature</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">temperature,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">response_format</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">{</span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"json_object"</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">tools</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[{</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"function"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #A5D6FF">"function"</span><span style="color: #C9D1D9">: {</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #A5D6FF">"name"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"JSON_soap_note"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">:</span><span style="color: #A5D6FF">"Clinical SOAP note as a JSON object"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #A5D6FF">"parameters"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">JSON_schema_obj</span></span>
<span class="line"><span style="color: #C9D1D9">                }</span></span>
<span class="line"><span style="color: #C9D1D9">            }],</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">tool_choice</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">{</span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"function"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"function"</span><span style="color: #C9D1D9">: {</span><span style="color: #A5D6FF">"name"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"JSON_soap_note"</span><span style="color: #C9D1D9">}},</span></span>
<span class="line"><span style="color: #C9D1D9">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        completion_string </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> response.choices[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">].message.tool_calls[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">].function.arguments</span></span>
<span class="line"><span style="color: #C9D1D9">        usage </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> response.usage</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        input_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> usage.prompt_tokens</span></span>
<span class="line"><span style="color: #C9D1D9">        output_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> usage.completion_tokens</span></span>
<span class="line"><span style="color: #C9D1D9">        pricing </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> model_pricing[model]</span></span>
<span class="line"><span style="color: #C9D1D9">        input_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pricing[</span><span style="color: #A5D6FF">'input_token_cost'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        output_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pricing[</span><span style="color: #A5D6FF">'output_token_cost'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        prediction_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ((input_tokens </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> input_cost) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> (output_tokens </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> output_cost))</span></span>
<span class="line"><span style="color: #C9D1D9">        prediction_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> time.time() </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> start_time</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        response_data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">: model,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">: temperature,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'input_tokens'</span><span style="color: #C9D1D9">: input_tokens,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'output_tokens'</span><span style="color: #C9D1D9">: output_tokens,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'input_cost'</span><span style="color: #C9D1D9">: input_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'output_cost'</span><span style="color: #C9D1D9">: output_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'prediction_cost'</span><span style="color: #C9D1D9">: prediction_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'prediction_time'</span><span style="color: #C9D1D9">: prediction_time,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'completion_string'</span><span style="color: #C9D1D9">: completion_string,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">: prompt_version</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E"># Parse completion string</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">            completion_data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> json.loads(completion_string)</span></span>
<span class="line"><span style="color: #C9D1D9">            response_data.update(completion_data)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">except</span><span style="color: #C9D1D9"> json.JSONDecodeError:</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> response_data</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">except</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Exception</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> e:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Error getting OpenAI completion data:"</span><span style="color: #C9D1D9">, e)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> {</span><span style="color: #A5D6FF">'error'</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(e)}</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">model</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'gpt-4o-mini'</span></span>
<span class="line"><span style="color: #C9D1D9">temperature </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"><span style="color: #C9D1D9">prompt_version </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span></span>
<span class="line"><span style="color: #C9D1D9">result </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> get_analysis_openai(system_content_string, user_content_string, model, temperature, prompt_version)</span></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(result)</span></span>
<span class="line"></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">calling get_analysis_openai with model: gpt-4o-mini</span></span>
<span class="line"><span style="color: #c9d1d9">{'model': 'gpt-4o-mini', 'temperature': 1, 'input_tokens': 1016, 'output_tokens': 652, 'input_cost': 0.00015, 'output_cost': 0.0006, 'prediction_cost': 0.0005436, 'prediction_time': 11.347606897354126, 'completion_string': '{"appointment_date":"2024-07-24","appointment_time":"15:36","chief_complaint":"Low back pain","soap_subjective":"Josephina Martina is a however-year-old female presenting with complaints of low back pain primarily associated with left-sided sciatica that has been ongoing since November. She reports that while she has been undergoing physical therapy, which initially improved her condition, her pain has recently worsened. The patient describes the pain as constant and radiating down her left leg. Importantly, she denies any alarming symptoms such as saddle anesthesia, loss of bowel or bladder control, and reports no weakness in her extremities. No history of abdominal pain, dysuria, or hematuria is noted. Josephina has no known drug allergies and is generally healthy, aside from her history of migraine headaches for which she is currently taking tenazidine. She is seeking treatment for this acute flare-up of sciatica until she can consult her primary care physician.","soap_objective":"- Patient appears in no acute distress but displays discomfort when addressing her back pain. \\n- Physical examination reveals tenderness in the lumbar region, particularly on the left side. \\n- Range of motion in the lower back is limited due to pain. \\n- Neurological examination indicates intact strength and sensation in both lower extremities, with straight leg raise testing positive for sciatic pain on the left side. \\n- No signs of dermatome loss or significant neurological deficits observed during examination.","soap_assessment":"Josephina is diagnosed with acute lumbar radiculopathy with left-sided sciatica as evidenced by her reported symptoms and objective findings during the examination. There are no signs of serious underlying conditions; however, the potential for a ruptured disc, nerve impingement, or degenerative disc disease has been recognized necessitating further imaging.","soap_plan":"The treatment plan includes a Medrol Dose Pack to manage inflammation and relieve pain; prescription to be dispensed per pharmacist with no refills. Additionally, Flexeril (cyclobenzaprine) 20 mg tablets are prescribed, with directions to take one by mouth as needed for muscle spasms. Pain management will also include Vicodin (hydrocodone/acetaminophen) 5-325 mg; the patient is to take one to two tablets by mouth every four to six hours as needed for pain, with a dispense quantity of 20 and no refills. The patient is also advised to arrange for an MRI of the lumbar spine to assess for any possible ruptured disk or other significant issues.","differential_diagnosis":"- Herniated lumbar disc: Given the radicular symptoms and history of worsening pain, this should be closely evaluated by MRI.\\n- Degenerative disc disease: Age-related changes could contribute to the patient‚Äôs sciatica.\\n- Lumbar spine stenosis: The possibility of narrowing in the spinal canal could be considered as a cause for her symptoms.\\n- Radiculopathy due to non-discal processes: Other sources such as piriformis syndrome or muscle strain may also cause similar presentations. \\n- Alternative treatment options include acupuncture, chiropractic care, or continued physical therapy emphasizing stretching and strengthening exercises.","patient_location":"unknown"}', 'prompt_version': 2, 'appointment_date': '2024-07-24', 'appointment_time': '15:36', 'chief_complaint': 'Low back pain', 'soap_subjective': 'Josephina Martina is a however-year-old female presenting with complaints of low back pain primarily associated with left-sided sciatica that has been ongoing since November. She reports that while she has been undergoing physical therapy, which initially improved her condition, her pain has recently worsened. The patient describes the pain as constant and radiating down her left leg. Importantly, she denies any alarming symptoms such as saddle anesthesia, loss of bowel or bladder control, and reports no weakness in her extremities. No history of abdominal pain, dysuria, or hematuria is noted. Josephina has no known drug allergies and is generally healthy, aside from her history of migraine headaches for which she is currently taking tenazidine. She is seeking treatment for this acute flare-up of sciatica until she can consult her primary care physician.', 'soap_objective': '- Patient appears in no acute distress but displays discomfort when addressing her back pain. \n- Physical examination reveals tenderness in the lumbar region, particularly on the left side. \n- Range of motion in the lower back is limited due to pain. \n- Neurological examination indicates intact strength and sensation in both lower extremities, with straight leg raise testing positive for sciatic pain on the left side. \n- No signs of dermatome loss or significant neurological deficits observed during examination.', 'soap_assessment': 'Josephina is diagnosed with acute lumbar radiculopathy with left-sided sciatica as evidenced by her reported symptoms and objective findings during the examination. There are no signs of serious underlying conditions; however, the potential for a ruptured disc, nerve impingement, or degenerative disc disease has been recognized necessitating further imaging.', 'soap_plan': 'The treatment plan includes a Medrol Dose Pack to manage inflammation and relieve pain; prescription to be dispensed per pharmacist with no refills. Additionally, Flexeril (cyclobenzaprine) 20 mg tablets are prescribed, with directions to take one by mouth as needed for muscle spasms. Pain management will also include Vicodin (hydrocodone/acetaminophen) 5-325 mg; the patient is to take one to two tablets by mouth every four to six hours as needed for pain, with a dispense quantity of 20 and no refills. The patient is also advised to arrange for an MRI of the lumbar spine to assess for any possible ruptured disk or other significant issues.', 'differential_diagnosis': '- Herniated lumbar disc: Given the radicular symptoms and history of worsening pain, this should be closely evaluated by MRI.\n- Degenerative disc disease: Age-related changes could contribute to the patient‚Äôs sciatica.\n- Lumbar spine stenosis: The possibility of narrowing in the spinal canal could be considered as a cause for her symptoms.\n- Radiculopathy due to non-discal processes: Other sources such as piriformis syndrome or muscle strain may also cause similar presentations. \n- Alternative treatment options include acupuncture, chiropractic care, or continued physical therapy emphasizing stretching and strengthening exercises.', 'patient_location': 'unknown'}</span></span></code></pre>
<p>Update Anthropic API call function to take prompt_version param:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">get_analysis_anthropic</span><span style="color: #C9D1D9">(system_content_string: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, user_content_string: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, model: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">, temperature: </span><span style="color: #79C0FF">float</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1.0</span><span style="color: #C9D1D9">, prompt_version: </span><span style="color: #79C0FF">int</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">f</span><span style="color: #A5D6FF">"calling get_analysis_anthropic with model: </span><span style="color: #79C0FF">{</span><span style="color: #C9D1D9">model</span><span style="color: #79C0FF">}</span><span style="color: #A5D6FF">"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    start_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> time.time()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        response </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> anthropic.messages.create(</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">model</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">model,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">messages</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span></span>
<span class="line"><span style="color: #C9D1D9">                {</span><span style="color: #A5D6FF">"role"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"user"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"content"</span><span style="color: #C9D1D9">: user_content_string},</span></span>
<span class="line"><span style="color: #C9D1D9">            ],</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">temperature</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">temperature,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">system</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">system_content_string,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">max_tokens</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">4096</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">tool_choice</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">{</span><span style="color: #A5D6FF">"type"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"tool"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"name"</span><span style="color: #C9D1D9">:</span><span style="color: #A5D6FF">"JSON_soap_note"</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FFA657">tools</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[{</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #A5D6FF">"name"</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"JSON_soap_note"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9">:</span><span style="color: #A5D6FF">"Clinical SOAP note as a JSON object"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #A5D6FF">"input_schema"</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">JSON_schema_obj</span></span>
<span class="line"><span style="color: #C9D1D9">                }]</span></span>
<span class="line"><span style="color: #C9D1D9">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        tool_use_block </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> response.content[</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        soap_note </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> tool_use_block.input</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        usage </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> response.usage</span></span>
<span class="line"><span style="color: #C9D1D9">        input_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> usage.input_tokens</span></span>
<span class="line"><span style="color: #C9D1D9">        output_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> usage.output_tokens</span></span>
<span class="line"><span style="color: #C9D1D9">        pricing </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> model_pricing[model]</span></span>
<span class="line"><span style="color: #C9D1D9">        input_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pricing[</span><span style="color: #A5D6FF">'input_token_cost'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">        output_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pricing[</span><span style="color: #A5D6FF">'output_token_cost'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        prediction_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ((input_tokens </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> input_cost) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> (output_tokens </span><span style="color: #FF7B72">/</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> output_cost))</span></span>
<span class="line"><span style="color: #C9D1D9">        prediction_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> time.time() </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> start_time</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        response_data </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">: model,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'temperature'</span><span style="color: #C9D1D9">: temperature,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'input_tokens'</span><span style="color: #C9D1D9">: input_tokens,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'output_tokens'</span><span style="color: #C9D1D9">: output_tokens,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'input_cost'</span><span style="color: #C9D1D9">: input_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'output_cost'</span><span style="color: #C9D1D9">: output_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'prediction_cost'</span><span style="color: #C9D1D9">: prediction_cost,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'prediction_time'</span><span style="color: #C9D1D9">: prediction_time,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'completion_string'</span><span style="color: #C9D1D9">: json.dumps(soap_note),</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">: prompt_version</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        response_data.update(soap_note)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> response_data</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">except</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Exception</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> e:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Error getting Anthropic completion data:"</span><span style="color: #C9D1D9">, e)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> {</span><span style="color: #A5D6FF">'error'</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">(e)}</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">model </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'claude-3-haiku-20240307'</span></span>
<span class="line"><span style="color: #C9D1D9">temperature </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">result </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> get_analysis_anthropic(system_content_string, user_content_string, model, temperature, prompt_version)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(result)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">calling get_analysis_anthropic with model: claude-3-haiku-20240307</span></span>
<span class="line"><span style="color: #c9d1d9">{'model': 'claude-3-haiku-20240307', 'temperature': 1, 'input_tokens': 1565, 'output_tokens': 551, 'input_cost': 0.00025, 'output_cost': 0.00125, 'prediction_cost': 0.00108, 'prediction_time': 3.8441195487976074, 'completion_string': '{"appointment_date": "2024-07-24", "appointment_time": "15:36", "chief_complaint": "Low back pain", "soap_subjective": "Josephina Martina, a 53-year-old female, presented with complaints of left-sided sciatic pain radiating down her left leg since November. She states she has been undergoing physical therapy which helped, but the pain has recently worsened, causing constant pain. She denies any red flags such as saddle anesthesia, loss of urine or bowel control, and weakness in the extremity.", "soap_objective": "No further objective observations or measurements were provided in the transcript.", "soap_assessment": "Based on the patient\'s symptomatology and the fact that she is young and otherwise healthy, the assessment is acute lumbar radiculopathy/sciatica.", "differential_diagnosis": "- Lumbar disc herniation\\n- Lumbar spinal stenosis\\n- Degenerative disc disease\\nThe patient should undergo an MRI of the lumbar spine to evaluate for the underlying cause of the sciatica, such as a ruptured disc, nerve impingement, or degenerative disc disease. If imaging is unremarkable, conservative management with physical therapy and medications may be sufficient.", "soap_plan": "1. Prescribed a medrol dose pack to be dispensed per pharmacist, no refill.\\n2. Prescribed Flexeril 20 mg, 1 tablet by mouth twice daily as needed for muscle spasm.\\n3. Prescribed Vicodin 5-325 mg, 1-2 tablets every 4-6 hours as needed for pain, dispense 20, no refill.\\n4. Recommended the patient undergo an MRI of the lumbar spine to evaluate for the underlying cause of the sciatica, such as a ruptured disc, nerve impingement, or degenerative disc disease.\\n5. Advised the patient to follow up with her primary care provider for further management."}', 'appointment_date': '2024-07-24', 'appointment_time': '15:36', 'chief_complaint': 'Low back pain', 'soap_subjective': 'Josephina Martina, a 53-year-old female, presented with complaints of left-sided sciatic pain radiating down her left leg since November. She states she has been undergoing physical therapy which helped, but the pain has recently worsened, causing constant pain. She denies any red flags such as saddle anesthesia, loss of urine or bowel control, and weakness in the extremity.', 'soap_objective': 'No further objective observations or measurements were provided in the transcript.', 'soap_assessment': "Based on the patient's symptomatology and the fact that she is young and otherwise healthy, the assessment is acute lumbar radiculopathy/sciatica.", 'differential_diagnosis': '- Lumbar disc herniation\n- Lumbar spinal stenosis\n- Degenerative disc disease\nThe patient should undergo an MRI of the lumbar spine to evaluate for the underlying cause of the sciatica, such as a ruptured disc, nerve impingement, or degenerative disc disease. If imaging is unremarkable, conservative management with physical therapy and medications may be sufficient.', 'soap_plan': '1. Prescribed a medrol dose pack to be dispensed per pharmacist, no refill.\n2. Prescribed Flexeril 20 mg, 1 tablet by mouth twice daily as needed for muscle spasm.\n3. Prescribed Vicodin 5-325 mg, 1-2 tablets every 4-6 hours as needed for pain, dispense 20, no refill.\n4. Recommended the patient undergo an MRI of the lumbar spine to evaluate for the underlying cause of the sciatica, such as a ruptured disc, nerve impingement, or degenerative disc disease.\n5. Advised the patient to follow up with her primary care provider for further management.'}</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">results_anthropic </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> model </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> anthropic_models:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> temperature </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> anthropic_temperatures:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _ </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(iterations):</span></span>
<span class="line"><span style="color: #C9D1D9">            result </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> get_analysis_anthropic(system_content_string, user_content_string, model, temperature, prompt_version)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> result:</span></span>
<span class="line"><span style="color: #C9D1D9">                results_anthropic.append(result)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Convert results to a DataFrame</span></span>
<span class="line"><span style="color: #C9D1D9">df_results_anthropic </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.DataFrame(results_anthropic)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Save to csv</span></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> os.path.exists(</span><span style="color: #A5D6FF">'results-anthropic.csv'</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    df_results_anthropic.to_csv(</span><span style="color: #A5D6FF">'results-anthropic.csv'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">mode</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'a'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">header</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">index</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #FF7B72">else</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">    df_results_anthropic.to_csv(</span><span style="color: #A5D6FF">'results-anthropic.csv'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">index</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">results_openai </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> model </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> openai_models:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> temperature </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> openai_temperatures:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> _ </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(iterations):</span></span>
<span class="line"><span style="color: #C9D1D9">            result </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> get_analysis_openai(system_content_string, user_content_string, model, temperature, prompt_version)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> result:</span></span>
<span class="line"><span style="color: #C9D1D9">                results_openai.append(result)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Convert results to a DataFrame</span></span>
<span class="line"><span style="color: #C9D1D9">df_results_openai </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.DataFrame(results_openai)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Save to csv</span></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> os.path.exists(</span><span style="color: #A5D6FF">'results-openai.csv'</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    df_results_openai.to_csv(</span><span style="color: #A5D6FF">'results-openai.csv'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">mode</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'a'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">header</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">index</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #FF7B72">else</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">    df_results_openai.to_csv(</span><span style="color: #A5D6FF">'results-openai.csv'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">index</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">False</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span></code></pre>
<h2 id="results-analysis-with-updated-prompt"><strong>RESULTS ANALYSIS WITH UPDATED PROMPT</strong></h2>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> google.colab </span><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> drive</span></span>
<span class="line"><span style="color: #C9D1D9">drive.mount(</span><span style="color: #A5D6FF">'/content/drive'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">df </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.read_csv(</span><span style="color: #A5D6FF">'/content/drive/MyDrive/soapnotescribe/combined-results-prompt-update.csv'</span><span style="color: #C9D1D9">)</span></span></code></pre>
<h2 id="analysis-prediction-time-1"><strong>Analysis: Prediction Time</strong></h2>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Exclude claude-3-opus model</span></span>
<span class="line"><span style="color: #C9D1D9">df </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.loc[df[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'claude-3-opus-20240229'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">avg_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby(</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)[</span><span style="color: #A5D6FF">'prediction_time'</span><span style="color: #C9D1D9">].mean().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_time'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby(</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)[</span><span style="color: #A5D6FF">'prediction_time'</span><span style="color: #C9D1D9">].agg([</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]).reset_index()</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(grouped_time, avg_time, </span><span style="color: #FFA657">left_on</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">right_on</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_time </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_time.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_time'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_time)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                        model       min        max   avg_time</span></span>
<span class="line"><span style="color: #c9d1d9">1     claude-3-haiku-20240307  2.904863   5.339926   3.794493</span></span>
<span class="line"><span style="color: #c9d1d9">2               gpt-3.5-turbo  2.403372   5.995300   4.075451</span></span>
<span class="line"><span style="color: #c9d1d9">4                      gpt-4o  3.496561  14.169378   6.490782</span></span>
<span class="line"><span style="color: #c9d1d9">5                 gpt-4o-mini  2.723844  14.743062   6.679159</span></span>
<span class="line"><span style="color: #c9d1d9">0  claude-3-5-sonnet-20240620  6.731199  18.393558  12.348582</span></span>
<span class="line"><span style="color: #c9d1d9">3                 gpt-4-turbo  8.035556  20.452861  13.798264</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">plt.figure(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i, row </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> grouped_time.iterrows():</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot([row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">]], [row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]], </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'black'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'-'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">marker</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'o'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'ro'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Max'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'avg_time'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'go'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Avg'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'bo'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Min'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.xlabel(</span><span style="color: #A5D6FF">'Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.ylabel(</span><span style="color: #A5D6FF">'Prediction Time (seconds)'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.title(</span><span style="color: #A5D6FF">'Min, Average, and Max Prediction Times (seconds) by Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.xticks(</span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">45</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'best'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_82_0.png" alt="png"></p>
<h2 id="conclusions-prediction-time"><strong>Conclusions: Prediction Time</strong></h2>
<ul>
<li>Fastest and Most Consistent Response Times: The models Claude-3-Haiku and gpt-3.5-turbo offer the quickest and most consistent response times.</li>
<li><strong>Performance Decline</strong>: gpt-4o-mini is no longer among the top performers for speed or consistency in predictions.</li>
</ul>
<p>Top Models for Prediction Speed and Consistency:</p>
<ul>
<li>gpt-3.5-turbo</li>
<li>Claude-3-Haiku</li>
</ul>
<h2 id="analysis-prediction-cost-with-updated-prompt"><strong>Analysis: Prediction Cost with Updated Prompt</strong></h2>
<p>What impact does the new prompt have on cost?</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Exclude claude-3-opus model</span></span>
<span class="line"><span style="color: #C9D1D9">df </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.loc[df[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'claude-3-opus-20240229'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Calculate average cost, grouping by both model and prompt_version</span></span>
<span class="line"><span style="color: #C9D1D9">avg_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'prediction_cost'</span><span style="color: #C9D1D9">].mean().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Calculate min and max costs, grouping by both model and prompt_version</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'prediction_cost'</span><span style="color: #C9D1D9">].agg([</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]).reset_index()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Merge the grouped cost with the average cost</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(grouped_cost, avg_cost, </span><span style="color: #FFA657">on</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Append prompt_version to the model name</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_cost[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">' (V='</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> grouped_cost[</span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">].astype(</span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">')'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_cost.drop(</span><span style="color: #FFA657">columns</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Sort the DataFrame by avg cost in ascending order</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_cost </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_cost.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_cost)</span></span>
<span class="line"></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                               model       min       max       avg</span></span>
<span class="line"><span style="color: #c9d1d9">10                 gpt-4o-mini (V=1)  0.000318  0.000402  0.000358</span></span>
<span class="line"><span style="color: #c9d1d9">11                 gpt-4o-mini (V=2)  0.000435  0.000607  0.000486</span></span>
<span class="line"><span style="color: #c9d1d9">4                gpt-3.5-turbo (V=1)  0.000847  0.001032  0.000936</span></span>
<span class="line"><span style="color: #c9d1d9">2      claude-3-haiku-20240307 (V=1)  0.000951  0.001081  0.001004</span></span>
<span class="line"><span style="color: #c9d1d9">5                gpt-3.5-turbo (V=2)  0.000937  0.001129  0.001040</span></span>
<span class="line"><span style="color: #c9d1d9">3      claude-3-haiku-20240307 (V=2)  0.000946  0.001259  0.001130</span></span>
<span class="line"><span style="color: #c9d1d9">8                       gpt-4o (V=1)  0.008860  0.010990  0.009821</span></span>
<span class="line"><span style="color: #c9d1d9">9                       gpt-4o (V=2)  0.010390  0.012520  0.011434</span></span>
<span class="line"><span style="color: #c9d1d9">0   claude-3-5-sonnet-20240620 (V=1)  0.012213  0.014403  0.013255</span></span>
<span class="line"><span style="color: #c9d1d9">1   claude-3-5-sonnet-20240620 (V=2)  0.017073  0.022578  0.019639</span></span>
<span class="line"><span style="color: #c9d1d9">6                  gpt-4-turbo (V=1)  0.018320  0.022490  0.020131</span></span>
<span class="line"><span style="color: #c9d1d9">7                  gpt-4-turbo (V=2)  0.019070  0.024710  0.021710</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">plt.figure(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i, row </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> grouped_cost.iterrows():</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot([row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">]], [row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]], </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'black'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'-'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">marker</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'o'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'ro'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Max'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'avg'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'go'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Avg'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'bo'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Min'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.xlabel(</span><span style="color: #A5D6FF">'Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.ylabel(</span><span style="color: #A5D6FF">'Prediction Cost $'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.title(</span><span style="color: #A5D6FF">'Min, Average, and Max Prediction Costs ($) by Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.xticks(</span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">90</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'best'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_86_0.png" alt="png"></p>
<p><strong>Conclusions: Prediction Cost</strong></p>
<p>Four pricing tiers - UPDATED</p>
<p>Low:</p>
<ul>
<li>gpt-4o-mini</li>
<li>gpt-3.5-turbo</li>
<li>claude-3-haiku</li>
</ul>
<p>Medium:</p>
<ul>
<li>gpt-4o</li>
</ul>
<p>High:</p>
<ul>
<li>claude-3.5-sonnet (moved up)</li>
<li>gpt-4-turbo</li>
</ul>
<p>Highest (excluded):</p>
<ul>
<li>claude-3-opus</li>
</ul>
<p>Cost conclusions:
Claude-3-opus is an outlier in high cost. Claude 3.5 sonnet should be in the same pricing tier as gpt-4-turbo.</p>
<p>Models with lowest cost:</p>
<ul>
<li>gpt-4o-mini</li>
<li>gpt-3.5-turbo</li>
<li>claude-3-haiku</li>
</ul>
<h2 id="analysis-output-tokens-with-prompt-versions"><strong>Analysis: Output Tokens with Prompt Versions</strong></h2>
<p>What impact did changing the prompt have on output tokens?</p>
<ul>
<li>V=1: First version</li>
<li>V=2: Updated system_prompt and JSON_schema to demand Differential Diagnosis and correct medication spelling/formatting</li>
</ul>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Exclude claude-3-opus model</span></span>
<span class="line"><span style="color: #C9D1D9">df </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.loc[df[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'claude-3-opus-20240229'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">avg_output_tokens </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'output_tokens'</span><span style="color: #C9D1D9">].mean().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_output'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'output_tokens'</span><span style="color: #C9D1D9">].agg([</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]).reset_index()</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(grouped_output, avg_output_tokens, </span><span style="color: #FFA657">on</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">' (V='</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">].astype(</span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">')'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.drop(</span><span style="color: #FFA657">columns</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_output'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_output)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                               model  min   max  avg_output</span></span>
<span class="line"><span style="color: #c9d1d9">4                gpt-3.5-turbo (V=1)  253   376      312.35</span></span>
<span class="line"><span style="color: #c9d1d9">8                       gpt-4o (V=1)  284   426      348.05</span></span>
<span class="line"><span style="color: #c9d1d9">5                gpt-3.5-turbo (V=2)  283   411      351.65</span></span>
<span class="line"><span style="color: #c9d1d9">6                  gpt-4-turbo (V=1)  299   438      359.35</span></span>
<span class="line"><span style="color: #c9d1d9">10                 gpt-4o-mini (V=1)  300   440      367.20</span></span>
<span class="line"><span style="color: #c9d1d9">7                  gpt-4-turbo (V=2)  294   482      382.00</span></span>
<span class="line"><span style="color: #c9d1d9">9                       gpt-4o (V=2)  354   496      423.60</span></span>
<span class="line"><span style="color: #c9d1d9">2      claude-3-haiku-20240307 (V=1)  469   573      511.10</span></span>
<span class="line"><span style="color: #c9d1d9">11                 gpt-4o-mini (V=2)  471   758      555.30</span></span>
<span class="line"><span style="color: #c9d1d9">3      claude-3-haiku-20240307 (V=2)  444   694      590.85</span></span>
<span class="line"><span style="color: #c9d1d9">0   claude-3-5-sonnet-20240620 (V=1)  538   684      607.45</span></span>
<span class="line"><span style="color: #c9d1d9">1   claude-3-5-sonnet-20240620 (V=2)  841  1208     1012.05</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">plt.figure(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> i, row </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> grouped_output.iterrows():</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot([row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">]], [row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">]], </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'black'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'-'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">marker</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'o'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'max'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'ro'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Max'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'avg_output'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'go'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Avg'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">    plt.plot(row[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], row[</span><span style="color: #A5D6FF">'min'</span><span style="color: #C9D1D9">], </span><span style="color: #A5D6FF">'bo'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Min'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.xlabel(</span><span style="color: #A5D6FF">'Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.ylabel(</span><span style="color: #A5D6FF">'Output Tokens'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.title(</span><span style="color: #A5D6FF">'Min, Max, and Average Output Tokens by Model'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.xticks(</span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">90</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'best'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">plt.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_90_0.png" alt="png"></p>
<p><strong>Output Token Conclusions</strong></p>
<ul>
<li>Anthropic‚Äôs Claude models generally produce more verbose outputs compared to OpenAI‚Äôs GPT models. However, with the revised prompt, the gpt-4o-mini model now generates outputs of comparable length to those of the Claude models.</li>
<li>With the revised prompt, claude-3.5-sonnet is now an outlier in long output length. Inspect these outputs closely (especially in the Differential Diagnosis field) to see what is going on.</li>
</ul>
<p>Models with output token preference:</p>
<ul>
<li>Not applicable. Longer/shorter is not necessarily better.</li>
</ul>
<h2 id="analysis-differential-diagnosis"><strong>Analysis: Differential Diagnosis</strong></h2>
<ul>
<li>Was a Differential Diagnosis returned? If so, what was the average length?</li>
<li>How many Differential Diagnosis values included ‚Äúalternative treatments‚Äù as requested in the system prompt?</li>
</ul>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Function to calculate the length of differential diagnosis or zero if empty</span></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">diagnosis_length</span><span style="color: #C9D1D9">(diagnosis: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(diagnosis) </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> diagnosis </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Exclude claude-3-opus model</span></span>
<span class="line"><span style="color: #C9D1D9">df </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.loc[df[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'claude-3-opus-20240229'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'differential_diagnosis'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'differential_diagnosis'</span><span style="color: #C9D1D9">].fillna(</span><span style="color: #A5D6FF">''</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Add a new column for the length of differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'diff_diag_length'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'differential_diagnosis'</span><span style="color: #C9D1D9">].apply(diagnosis_length)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Count the number of rows with a non-empty differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'has_diff_diag'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'differential_diagnosis'</span><span style="color: #C9D1D9">].apply(</span><span style="color: #FF7B72">lambda</span><span style="color: #C9D1D9"> x: </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Check if 'alternative' is in the differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'has_alternative'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'differential_diagnosis'</span><span style="color: #C9D1D9">].apply(</span><span style="color: #FF7B72">lambda</span><span style="color: #C9D1D9"> x: </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'alternative'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> x.lower() </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Calculate the average length of differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">avg_diff_length </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'diff_diag_length'</span><span style="color: #C9D1D9">].mean().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_diff_length'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Count the number of rows with a non-empty differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">total_diff_diag </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'has_diff_diag'</span><span style="color: #C9D1D9">].sum().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'total_diff_diag'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Count the number of rows with 'alternative' in the differential diagnosis</span></span>
<span class="line"><span style="color: #C9D1D9">total_alternative </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'has_alternative'</span><span style="color: #C9D1D9">].sum().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'total_alternative'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Merge the results</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(avg_diff_length, total_diff_diag, </span><span style="color: #FFA657">on</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(grouped_output, total_alternative, </span><span style="color: #FFA657">on</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Append temperature to the model name</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">' (V='</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">].astype(</span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">')'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Drop the temperature column</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.drop(</span><span style="color: #FFA657">columns</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Sort the DataFrame by avg_diff_length in ascending order</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'avg_diff_length'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_output)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                               model  avg_diff_length  total_diff_diag  \</span></span>
<span class="line"><span style="color: #c9d1d9">8                       gpt-4o (V=1)           150.80               20</span></span>
<span class="line"><span style="color: #c9d1d9">7                  gpt-4-turbo (V=2)           155.65               20</span></span>
<span class="line"><span style="color: #c9d1d9">9                       gpt-4o (V=2)           157.80               20</span></span>
<span class="line"><span style="color: #c9d1d9">2      claude-3-haiku-20240307 (V=1)           190.65               20</span></span>
<span class="line"><span style="color: #c9d1d9">4                gpt-3.5-turbo (V=1)           196.95               17</span></span>
<span class="line"><span style="color: #c9d1d9">0   claude-3-5-sonnet-20240620 (V=1)           201.10               20</span></span>
<span class="line"><span style="color: #c9d1d9">10                 gpt-4o-mini (V=1)           227.85               20</span></span>
<span class="line"><span style="color: #c9d1d9">5                gpt-3.5-turbo (V=2)           244.80               20</span></span>
<span class="line"><span style="color: #c9d1d9">6                  gpt-4-turbo (V=1)           261.05               20</span></span>
<span class="line"><span style="color: #c9d1d9">3      claude-3-haiku-20240307 (V=2)           299.30               20</span></span>
<span class="line"><span style="color: #c9d1d9">11                 gpt-4o-mini (V=2)           376.10               20</span></span>
<span class="line"><span style="color: #c9d1d9">1   claude-3-5-sonnet-20240620 (V=2)          1307.85               20</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span>
<span class="line"><span style="color: #c9d1d9">    total_alternative</span></span>
<span class="line"><span style="color: #c9d1d9">8                   6</span></span>
<span class="line"><span style="color: #c9d1d9">7                   4</span></span>
<span class="line"><span style="color: #c9d1d9">9                   6</span></span>
<span class="line"><span style="color: #c9d1d9">2                   5</span></span>
<span class="line"><span style="color: #c9d1d9">4                   8</span></span>
<span class="line"><span style="color: #c9d1d9">0                   4</span></span>
<span class="line"><span style="color: #c9d1d9">10                 17</span></span>
<span class="line"><span style="color: #c9d1d9">5                  20</span></span>
<span class="line"><span style="color: #c9d1d9">6                  13</span></span>
<span class="line"><span style="color: #c9d1d9">3                  14</span></span>
<span class="line"><span style="color: #c9d1d9">11                 19</span></span>
<span class="line"><span style="color: #c9d1d9">1                  20</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"></span>
<span class="line"><span style="color: #8B949E"># Plotting the data</span></span>
<span class="line"><span style="color: #C9D1D9">fig, ax1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> plt.subplots(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Bar chart for total differentials</span></span>
<span class="line"><span style="color: #C9D1D9">bar1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ax1.bar(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], grouped_output[</span><span style="color: #A5D6FF">'total_diff_diag'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Total Differential Diagnoses Returned'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'skyblue'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">edgecolor</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'skyblue'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Bar chart for differentials that include "alternative"</span></span>
<span class="line"><span style="color: #C9D1D9">bar2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ax1.bar(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], grouped_output[</span><span style="color: #A5D6FF">'total_alternative'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Differentials included alternative treatment'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'lightcoral'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Secondary y-axis for average differential diagnosis length</span></span>
<span class="line"><span style="color: #C9D1D9">ax2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ax1.twinx()</span></span>
<span class="line"><span style="color: #C9D1D9">ax2.plot(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], grouped_output[</span><span style="color: #A5D6FF">'avg_diff_length'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'green'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">marker</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'o'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">''</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linewidth</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">markersize</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Average Differential Diagnosis Length'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Customizing the plot</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xlabel(</span><span style="color: #A5D6FF">'Model (Temperature)'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_ylabel(</span><span style="color: #A5D6FF">'Number of Differential Diagnoses Returned'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax2.set_ylabel(</span><span style="color: #A5D6FF">'Average Differential Diagnosis Length (characters)'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_title(</span><span style="color: #A5D6FF">'Inclusion of Differential Diagnosis by Model, Two Prompt Versions'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xticks(</span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">])))</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xticklabels(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">45</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ha</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'right'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'upper left'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">bbox_to_anchor</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0.0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1.15</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">ncol</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax2.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'upper right'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">bbox_to_anchor</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1.0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1.15</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">ncol</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Display the plot</span></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_95_0.png" alt="png"></p>
<p><strong>Conclusions: Differential Diagnosis</strong></p>
<p>The Claude-3.5-Sonnet model, using the new prompt, produces Differential Diagnosis outputs that are 3 to 5 times longer than those from other models.</p>
<p>Manual review indicates that these longer outputs are of high quality and significantly enrich the SOAP notes.</p>
<p><strong>Best Models for Differential Diagnosis:</strong></p>
<ul>
<li>Claude-3.5-Sonnet: Consistently provides a detailed Differential Diagnosis along with alternative treatment options, as requested. Notably produces longer, more comprehensive responses.</li>
<li>gpt-3.5-turbo: Also reliably returns a Differential Diagnosis with alternative treatment options.</li>
<li>gpt-4o-mini: Almost always returns a Differential Diagnosis with alternative treatment options. Good response length.</li>
</ul>
<h2 id="analysis-fixing-transcription-errors-1"><strong>Analysis: Fixing Transcription Errors</strong></h2>
<p>The transcript includes the text ‚ÄúVicodin 5-3, 25 milligrams‚Äù for when the speaker said ‚ÄúVicodin five slash three twenty-five milligrams.‚Äù This should have been transcribed as ‚ÄúVicodin 5/325 milligrams.‚Äù</p>
<p>The dosage of medications is typically written with a slash (‚Äù/‚Äù) to clearly separate the amounts of each ingredient. ‚Äú5‚Äù represents the amount of hydrocodone (usually in milligrams), and ‚Äú325‚Äù represents the amount of acetaminophen (also in milligrams).
‚ÄúVicodin 5/325‚Äù means each tablet contains 5 mg of hydrocodone and 325 mg of acetaminophen.</p>
<p>The transcript also includes a spelling error related to a medication name: ‚Äúflexor all 20 milligram tablets‚Äù should be ‚ÄúFlexeril 20 milligram tablets‚Äù.</p>
<p>While this was not specifically requested in the prompt, some of the models caught these mistakes in the transcript and automatically fixed them in the response.</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Function to calculate whether the soap_plan includes the text 5/325</span></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">check_formatting</span><span style="color: #C9D1D9">(soap_plan: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"5/325"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> soap_plan </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Function to calculate whether the soap_plan includes the text flexeril</span></span>
<span class="line"><span style="color: #FF7B72">def</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">check_spelling</span><span style="color: #C9D1D9">(soap_plan: </span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">):</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"flexeril"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> soap_plan.lower() </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #8B949E"># Exclude claude-3-opus model</span></span>
<span class="line"><span style="color: #C9D1D9">df </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.loc[df[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'claude-3-opus-20240229'</span><span style="color: #C9D1D9">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Add a new column to store whether soap_plan includes corrrect formatting of 5/325</span></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'corrected_formatting'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'soap_plan'</span><span style="color: #C9D1D9">].apply(check_formatting)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Add a new column to store whether soap_plan includes corrected spelling of flexeril</span></span>
<span class="line"><span style="color: #C9D1D9">df[</span><span style="color: #A5D6FF">'corrected_spelling'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df[</span><span style="color: #A5D6FF">'soap_plan'</span><span style="color: #C9D1D9">].apply(check_spelling)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Count the number of rows with correct formatting</span></span>
<span class="line"><span style="color: #C9D1D9">total_formatted </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'corrected_formatting'</span><span style="color: #C9D1D9">].sum().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'total_formatted'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Count the number of rows with correct spelling</span></span>
<span class="line"><span style="color: #C9D1D9">total_spelling </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> df.groupby([</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])[</span><span style="color: #A5D6FF">'corrected_spelling'</span><span style="color: #C9D1D9">].sum().reset_index(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'total_spelling'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Merge the results ()</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> pd.merge(total_formatted, total_spelling, </span><span style="color: #FFA657">on</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">how</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'inner'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Append prompt_version to the model name</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">' (V='</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> grouped_output[</span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">].astype(</span><span style="color: #79C0FF">str</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">')'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Drop the prompt_version column</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.drop(</span><span style="color: #FFA657">columns</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">[</span><span style="color: #A5D6FF">'prompt_version'</span><span style="color: #C9D1D9">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Sort the DataFrame by total_formatted in ascending order</span></span>
<span class="line"><span style="color: #C9D1D9">grouped_output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> grouped_output.sort_values(</span><span style="color: #FFA657">by</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'total_formatted'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ascending</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">True</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">print</span><span style="color: #C9D1D9">(grouped_output)</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #c9d1d9">                               model  total_formatted  total_spelling</span></span>
<span class="line"><span style="color: #c9d1d9">0   claude-3-5-sonnet-20240620 (V=1)                0              20</span></span>
<span class="line"><span style="color: #c9d1d9">10                 gpt-4o-mini (V=1)                0              20</span></span>
<span class="line"><span style="color: #c9d1d9">1   claude-3-5-sonnet-20240620 (V=2)                1              20</span></span>
<span class="line"><span style="color: #c9d1d9">3      claude-3-haiku-20240307 (V=2)                1              19</span></span>
<span class="line"><span style="color: #c9d1d9">4                gpt-3.5-turbo (V=1)                1               7</span></span>
<span class="line"><span style="color: #c9d1d9">6                  gpt-4-turbo (V=1)                2               9</span></span>
<span class="line"><span style="color: #c9d1d9">2      claude-3-haiku-20240307 (V=1)                3              20</span></span>
<span class="line"><span style="color: #c9d1d9">11                 gpt-4o-mini (V=2)                4              20</span></span>
<span class="line"><span style="color: #c9d1d9">7                  gpt-4-turbo (V=2)                6              16</span></span>
<span class="line"><span style="color: #c9d1d9">5                gpt-3.5-turbo (V=2)               12               8</span></span>
<span class="line"><span style="color: #c9d1d9">8                       gpt-4o (V=1)               16              20</span></span>
<span class="line"><span style="color: #c9d1d9">9                       gpt-4o (V=2)               17              20</span></span></code></pre>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"></span>
<span class="line"><span style="color: #8B949E"># Plotting the data</span></span>
<span class="line"><span style="color: #C9D1D9">fig, ax1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> plt.subplots(</span><span style="color: #FFA657">figsize</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">12</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">8</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">bar_width </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0.35</span></span>
<span class="line"><span style="color: #C9D1D9">opacity </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0.8</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Bar chart for total corrected values</span></span>
<span class="line"><span style="color: #C9D1D9">bar1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ax1.bar(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], grouped_output[</span><span style="color: #A5D6FF">'total_formatted'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">width</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">bar_width, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Corrected Medication Formatting'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'skyblue'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">edgecolor</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'skyblue'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">bar2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ax1.bar([x </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> bar_width </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">]))], grouped_output[</span><span style="color: #A5D6FF">'total_spelling'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">width</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">bar_width, </span><span style="color: #FFA657">label</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'Corrected Medication Spelling'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">color</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'lightcoral'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Customizing the plot</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xlabel(</span><span style="color: #A5D6FF">'Model (Version)'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_ylabel(</span><span style="color: #A5D6FF">'Number of Corrections Made'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_title(</span><span style="color: #A5D6FF">'Correction of Transcription Errors'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xticks(</span><span style="color: #79C0FF">range</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">len</span><span style="color: #C9D1D9">(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">])))</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.set_xticklabels(grouped_output[</span><span style="color: #A5D6FF">'model'</span><span style="color: #C9D1D9">], </span><span style="color: #FFA657">rotation</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">90</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ha</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'right'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.legend(</span><span style="color: #FFA657">loc</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'upper left'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">bbox_to_anchor</span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0.0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1.15</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">ncol</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">ax1.grid(</span><span style="color: #FFA657">axis</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'y'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">linestyle</span><span style="color: #FF7B72">=</span><span style="color: #A5D6FF">'--'</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">alpha</span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0.7</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E"># Display the plot</span></span>
<span class="line"><span style="color: #C9D1D9">plt.tight_layout()</span></span>
<span class="line"><span style="color: #C9D1D9">plt.show()</span></span></code></pre>
<p><img src="/blogimages/model_and_prompt_evals_files/model_and_prompt_evals_101_0.png" alt="png"></p>
<p><strong>Conclusions: Fixing Transcription Errore</strong></p>
<p><strong>General improvement with prompt update</strong>:</p>
<ul>
<li>All of the models, except for Claude-3-Haiku, showed performance improvement in detecting transcription errors with the updated prompt.</li>
</ul>
<p><strong>Best model for fixing transcription errors</strong>:</p>
<ul>
<li>GPT-4o excelled at identifying spelling and formatting errors in prescription medications, outperforming all other models even with the initial prompt (Prompt V1).</li>
</ul>
<p><strong>General Observations</strong>:</p>
<ul>
<li>The updated system prompt and JSON schema have enhanced the detection of medication transcription errors, but issues persist, particularly with formatting. Spelling errors are generally easier to identify than formatting issues. It may be beneficial to provide the prompt with examples of correct medication formatting to further reduce errors.</li>
</ul>
<h2 id="conclusions"><strong>CONCLUSIONS</strong></h2>
<h3 id="model-rankings-by-criteria"><strong>Model Rankings by Criteria</strong></h3>
<p>To determine the ‚Äúbest model,‚Äù it‚Äôs crucial to identify and evaluate the most important criteria for your use case. Model performance can vary significantly across these criteria. The following rankings are organized from the most to least important criteria for this particular application:</p>
<p><strong>Lowest cost:</strong></p>
<ol>
<li>gpt-4o-mini</li>
<li>claude-3-haiku</li>
<li>gpt-3.5-turbo</li>
</ol>
<p><strong>Inclusion of Differential Diagnosis and alternative treatment:</strong></p>
<ol>
<li>claude-3.5-sonnet (long, very thorough)</li>
<li>gpt-3.5-turbo</li>
<li>gpt-4o-mini</li>
</ol>
<p><strong>Fixing transcription errors:</strong></p>
<ol>
<li>gpt-4o</li>
</ol>
<p><strong>Quick, consistent prediction times:</strong></p>
<ol>
<li>claude-3-haiku</li>
<li>gpt-3.5-turbo</li>
</ol>
<h3 id="understand-how-your-prompt-affects-model-performance"><strong>Understand How Your <em>Prompt</em> Affects Model Performance.</strong></h3>
<p>Changing the prompt can significantly alter model ranking. For instance, adjusting the prompt may lead to notable changes in output length for some models while affecting others minimally. A model that was previously cost-effective might shift to a higher pricing tier with a new prompt.</p>
<h3 id="use-prompt-development-to-pass-desired-traits-between-models"><strong>Use Prompt Development to ‚ÄúPass Desired Traits‚Äù Between Models</strong></h3>
<p>If you select gpt-4o-mini for its low cost and acceptable performance on Differential Diagnosis but have concerns about its transcription error handling, consider enhancing the prompt with a dictionary of common prescription names and detailed formatting instructions.</p>
<p>To increase the length and detail of the Differential Diagnosis, you can use outputs from claude-3.5-sonnet as few-shot examples or set a character length minimum in the JSON schema to guide other models.</p>
<p>By systematically evaluating model outputs in this way, you can incorporate the content or structure of the best model outputs into your prompt and avoid having to compromise on model selection.</p>
<p>As a result of building and running this notebook, I have switched to using gpt-4o-mini for the time being based on its cost-effectiveness and performance in the Differential Diagnosis field. As discussed above, I have a clear strategy for further refining the prompt to enhance both Differential Diagnosis results and transcription error correction in gpt-4o-mini.</p>
<p>Finally, I am better prepared to quickly evaluate and compare new models as they become available, ensuring that I can effectively assess performance differences and make informed decisions about model selection for this specific use case.</p>
<h3 id="takeaways"><strong>Takeaways</strong>:</h3>
<ul>
<li><strong>Doing ‚Äúevals‚Äù is not simply a choice between manual human review or using an AI to grade outputs.</strong> There is a third way. Data analysis can provide valuable insights for both prompt and model evaluations.</li>
<li>Improving the prompt can change model rankings. Use prompt improvement (system prompt + JSON schema) to ‚Äúpass‚Äù desired traits from one model into another model. <strong>Fully optimize the prompt before drawing conclusions about the ‚Äúbest model.‚Äù</strong></li>
<li><strong>Have a plan</strong> in place for systematically testing new models once they are released.</li>
</ul>
    </article>
  </main>
          </main>
        </div>
      </div>
      <div class="drawer-side bg-base-200">
  <label for="my-drawer" class="drawer-overlay bg-base-200"></label>
  <div class="menu flex flex-col flex-nowrap p-4 overflow-y-auto w-[21rem] bg-base-200 text-base-content">
    <div class="w-fit">
      <a href="/">
        <div class="avatar transition ease-in-out w-1/2 hover:scale-[102%] block m-auto mt-3 mb-6">
          <div class="bg-base-200" style="width: 152px; height:152px;">
            <img class="mask mask-circle" src="/profile.webp" alt="profile image">
          </div>
        </div>
      </a>
    </div>
    <ul class="grow shrink">
      <!-- Sidebar content here -->
      <li><a href="/">Home</a></li>
      <li><a href="/projects">Projects</a></li>
      <li><a href="/blog/">Blog</a></li>
      <li><a href="mailto:joseph.r.martinez@gmail.com">Contact</a></li>
    </ul>
    <div class="social-icons px-4 my-2 flex self-center items-center">
      <a href="https://github.com/josephrmartinez" target="_blank" class="mx-3" aria-label="Github" title="Github">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;" class="hover:text-orange-600 transition duration-200 ease-in-out"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.026 2c-5.509 0-9.974 4.465-9.974 9.974 0 4.406 2.857 8.145 6.821 9.465.499.09.679-.217.679-.481 0-.237-.008-.865-.011-1.696-2.775.602-3.361-1.338-3.361-1.338-.452-1.152-1.107-1.459-1.107-1.459-.905-.619.069-.605.069-.605 1.002.07 1.527 1.028 1.527 1.028.89 1.524 2.336 1.084 2.902.829.091-.645.351-1.085.635-1.334-2.214-.251-4.542-1.107-4.542-4.93 0-1.087.389-1.979 1.024-2.675-.101-.253-.446-1.268.099-2.64 0 0 .837-.269 2.742 1.021a9.582 9.582 0 0 1 2.496-.336 9.554 9.554 0 0 1 2.496.336c1.906-1.291 2.742-1.021 2.742-1.021.545 1.372.203 2.387.099 2.64.64.696 1.024 1.587 1.024 2.675 0 3.833-2.33 4.675-4.552 4.922.355.308.675.916.675 1.846 0 1.334-.012 2.41-.012 2.737 0 .267.178.577.687.479C19.146 20.115 22 16.379 22 11.974 22 6.465 17.535 2 12.026 2z"></path>
        </svg>
      </a>
      <a href="https://www.linkedin.com/in/joseph-martinez-08174811/" target="_blank" class="mx-3" aria-label="Linkedin" title="Linkedin">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="hover:text-orange-600 transition duration-200 ease-in-out" style="fill: currentColor;transform: ;msFilter:;"><circle cx="4.983" cy="5.009" r="2.188"></circle><path d="M9.237 8.855v12.139h3.769v-6.003c0-1.584.298-3.118 2.262-3.118 1.937 0 1.961 1.811 1.961 3.218v5.904H21v-6.657c0-3.27-.704-5.783-4.526-5.783-1.835 0-3.065 1.007-3.568 1.96h-.051v-1.66H9.237zm-6.142 0H6.87v12.139H3.095z"></path>
        </svg>
      </a>

      <a href="https://www.youtube.com/channel/UCMImPk4uRUQISaOLl5tB3yA" target="_blank" class="mx-3" aria-label="YouTube" title="YouTube">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-youtub inline-block hover:text-orange-600 transition duration-200 ease-in-out" viewBox="0 0 16 16">
          <path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"></path>
        </svg>
      </a>

      <a href="https://medium.com/@joseph.r.martinez" target="_blank" class="mx-3" aria-label="Medium" title="Medium">
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" class="inline-block hover:text-orange-600 transition duration-200 ease-in-out" viewBox="0 0 256 256"><path d="M136,128A64,64,0,1,1,72,64,64.07,64.07,0,0,1,136,128Zm48-64c-5.68,0-16.4,2.76-24.32,21.25C154.73,96.8,152,112,152,128s2.73,31.2,7.68,42.75C167.6,189.24,178.32,192,184,192s16.4-2.76,24.32-21.25C213.27,159.2,216,144,216,128s-2.73-31.2-7.68-42.75C200.4,66.76,189.68,64,184,64Zm56,0a8,8,0,0,0-8,8V184a8,8,0,0,0,16,0V72A8,8,0,0,0,240,64Z"></path></svg>
      </a>
      <a href="/rss.xml" target="_blank" class="mx-3" aria-label="RSS Feed" title="RSS Feed">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><path d="M19 20.001C19 11.729 12.271 5 4 5v2c7.168 0 13 5.832 13 13.001h2z"></path><path d="M12 20.001h2C14 14.486 9.514 10 4 10v2c4.411 0 8 3.589 8 8.001z"></path><circle cx="6" cy="18" r="2"></circle>
        </svg>
    </a>
    </div>
  </div>
</div>
    </div>
  </body></html>